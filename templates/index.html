<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Th∆∞ vi·ªán ·∫£nh</title>
  <style>
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
          font-family: sans-serif;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          min-height: 100vh;
          padding: 20px;
      }

      .container {
          max-width: 1200px;
          margin: 0 auto;
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }

      h1 {
          text-align: center;
          color: #667eea;
          margin-bottom: 30px;
          font-size: 2.5em;
      }

      .search-box {
          display: flex;
          gap: 10px;
          margin-bottom: 30px;
          max-width: 600px;
          margin-left: auto;
          margin-right: auto;
      }

      .search-box input {
          flex: 1;
          padding: 15px 20px;
          border: 2px solid #667eea;
          border-radius: 50px;
          font-size: 16px;
          outline: none;
      }

      .search-box button {
          padding: 15px 30px;
          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
          color: white;
          border: none;
          border-radius: 50px;
          cursor: pointer;
      }

      .image-grid {
          display: grid;
          grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
          gap: 20px;
      }

      .image-card {
          background: white;
          border-radius: 15px;
          overflow: hidden;
          box-shadow: 0 5px 15px rgba(0,0,0,0.1);
          cursor: pointer;
          transition: 0.3s;
      }

      .image-card:hover {
          transform: translateY(-8px);
          box-shadow: 0 15px 30px rgba(0,0,0,0.2);
      }

      .image-card img {
          width: 100%;
          height: 200px;
          object-fit: cover;
      }

      .image-info { padding: 15px; }
      .image-info h3 { margin-bottom: 5px; }
      .tags { color: #667eea; font-style: italic; font-size: 14px; }

      .no-results { text-align: center; padding: 40px; color: #777; }
  </style>
</head>
<!--UPDATE BODY ƒê·ªÇ HI·ªÜN RA T√åM KI·∫æM B·∫∞NG H√åNH ·∫¢NH--> 
<body>

  <!-- n√∫t chuy·ªÉn ƒë·∫øn trang t√¨m ki·∫øm b·∫±ng ·∫£nh -->
  <p style="text-align: center;">
  <a href="/search_image" style="
    display: inline-block;
    background-color: #4CAF50;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    margin: 0 10px 20px 0;
  ">üîç T√¨m ki·∫øm b·∫±ng h√¨nh ·∫£nh</a>

  <a href="/map" style="
    display: inline-block;
    background-color: #2196F3;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    margin-bottom: 20px;
  ">üó∫Ô∏è Xem b·∫£n ƒë·ªì</a>

  <a href="/chat_ui" style="
    display: inline-block;
    background-color: #9C27B0;
    color: white;
    padding: 10px 20px;
    border-radius: 6px;
    text-decoration: none;
    margin-bottom: 20px;
  ">üí¨ Chatbot du l·ªãch</a>
</p>
<div class="container">
  <h1>Th∆∞ vi·ªán ·∫£nh</h1>

  <div class="search-box">
      <input id="searchInput" placeholder="Nh·∫≠p t·ª´ kh√≥a: cat, dog, mountain..." value="{{ keyword }}">
      <button onclick="searchImages()">T√¨m ki·∫øm</button>
  </div>

  <!-- B·ªô l·ªçc n√¢ng cao -->
    <div class="search-box" style="margin-top: 10px;">
      <input id="cityInput" placeholder="Th√†nh ph·ªë (VD: H√† N·ªôi)">
      <input id="tagInput" placeholder="Th·∫ª (VD: l·ªãch s·ª≠, bi·ªÉn)">
      <input id="ratingInput" type="number" min="0" max="5" step="0.5" placeholder="ƒêi·ªÉm ƒë√°nh gi√° t·ªëi thi·ªÉu">
      <button onclick="searchFilter()">L·ªçc</button>
    </div>

    <!-- T√¨m ki·∫øm th√¥ng minh b·∫±ng ng√¥n ng·ªØ t·ª± nhi√™n -->
    <div class="search-box" style="margin-top: 10px;">
      <input id="queryText" placeholder="Nh·∫≠p m√¥ t·∫£ (VD: ƒë·ªãa ƒëi·ªÉm c√≥ nhi·ªÅu c√¢y xanh, g·∫ßn bi·ªÉn...)">
      <button onclick="searchText()">T√¨m b·∫±ng AI</button>
  </div>

  {% if keyword %}
  <div style="text-align:center; margin-bottom:15px;">
      T√¨m th·∫•y <b>{{ images|length }}</b> ·∫£nh cho "<b>{{ keyword }}</b>"
  </div>
  {% else %}
  <div style="text-align:center; margin-bottom:15px;">
      Hi·ªÉn th·ªã <b>{{ images|length }}</b> ·∫£nh
  </div>
  {% endif %}

  <div id="results" class="image-grid">
    {% for image in images %}
    <div class="image-card" data-id="{{ image.id }}" onclick="viewDetail(this.dataset.id)">
      <img src="{{ url_for('static', filename='images/' + image.filename) }}"
        alt="{{ image.name }}">
          <div class="image-info">
            <h3>{{ image.name }}</h3>
              <div class="tags">{{ image.tags }}</div>
          </div>
    </div>
        {% endfor %}
   </div>
</div>

<script>
  async function searchImages() {
    const query = document.getElementById('searchInput').value.trim();
    const res = await fetch(`/api/search?q=${encodeURIComponent(query)}`);
    const data = await res.json();

    const container = document.getElementById('results');
    if (!container) return;

    if (data.length === 0) {
      container.innerHTML = `<div class="no-results">Kh√¥ng t√¨m th·∫•y ·∫£nh n√†o cho "<b>${query}</b>"</div>`;
      return;
    }

    container.innerHTML = data.map(img => `
      <div class="image-card" onclick="viewDetail(${img.id})">
        <img src="/static/images/${img.filename}" alt="${img.name}">
        <div class="image-info">
          <h3>${img.name}</h3>
          <div class="tags">${img.tags || ''}</div>
        </div>
      </div>
    `).join('');
  }

  document.getElementById('searchInput').addEventListener('keypress', e => {
    if (e.key === 'Enter') searchImages();
  });

  function viewDetail(imageId) {
    window.location.href = '/image/' + imageId;
  }

  // T·∫£i t·∫•t c·∫£ ·∫£nh khi m·ªü trang
  window.onload = () => searchImages();

  // L·ªçc theo th√†nh ph·ªë, th·∫ª v√† ƒë√°nh gi√°
async function searchFilter() {
  const city = document.getElementById('cityInput').value.trim();
  const tag = document.getElementById('tagInput').value.trim();
  const rating = document.getElementById('ratingInput').value.trim() || 0;

  const url = `/search_filter?city=${encodeURIComponent(city)}&tag=${encodeURIComponent(tag)}&rating=${rating}`;
  const res = await fetch(url);
  const data = await res.json();

  const container = document.getElementById('results');
  if (!container) return;

  if (data.length === 0) {
    container.innerHTML = `<div class="no-results">Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm ph√π h·ª£p</div>`;
    return;
  }

  container.innerHTML = data.map(place => `
    <div class="image-card" onclick="viewDetail(${place.id})">
      <img src="/static/images/${place.image || 'default.jpg'}" alt="${place.name}">
      <div class="image-info">
        <h3>${place.name}</h3>
        <div class="tags">${place.city || ''} - ${place.tags || ''}</div>
        <div class="tags">‚≠ê ${place.rating || '0'}</div>
      </div>
    </div>
  `).join('');
}

// T√¨m b·∫±ng AI (Semantic Search)
async function searchText() {
  const query = document.getElementById('queryText').value.trim();
  if (!query) return;

  const res = await fetch(`/search_text?query=${encodeURIComponent(query)}`);
  const data = await res.json();

  const container = document.getElementById('results');
  if (!container) return;

  if (data.length === 0) {
    container.innerHTML = `<div class="no-results">Kh√¥ng t√¨m th·∫•y k·∫øt qu·∫£ ph√π h·ª£p cho "${query}"</div>`;
    return;
  }

  container.innerHTML = data.map(place => `
    <div class="image-card" onclick="viewDetail(${place.id})">
      <img src="/static/images/${place.image || 'default.jpg'}" alt="${place.name}">
      <div class="image-info">
        <h3>${place.name}</h3>
        <div class="tags">${place.city || ''} - ${place.tags || ''}</div>
        <div class="tags">‚≠ê ${place.rating || '0'}</div>
      </div>
    </div>
  `).join('');
}
</script>

</body>
</html>
