<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ image.name }} - LocaGo!</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
      /* --- COPY STYLES T·ª™ INDEX.HTML --- */
      * { margin: 0; padding: 0; box-sizing: border-box; }

      body {
          font-family: 'Poppins', sans-serif;
          background: #f5f5f5;
          min-height: 100vh;
          color: #333;
      }

      /* Header Styles */
      header {
          background: white;
          box-shadow: 0 2px 10px rgba(0,0,0,0.1);
          padding: 15px 30px;
          position: sticky;
          top: 0;
          z-index: 1000;
      }

      .header-container {
          max-width: 1400px;
          margin: 0 auto;
          display: flex;
          justify-content: space-between;
          align-items: center;
      }

      .logo {
          font-size: 32px;
          font-weight: 700;
          color: #1C6758;
          text-decoration: none;
      }

      .logo span { color: #8EB486; }

      .nav-links {
          display: flex;
          gap: 20px;
          align-items: center;
          position: relative;
      }

      .nav-links a, .nav-links button {
          text-decoration: none;
          color: #333;
          padding: 10px 18px;
          border-radius: 8px;
          transition: 0.3s;
          border: none;
          background: transparent;
          cursor: pointer;
          font-size: 15px;
          font-weight: 500;
          font-family: 'Poppins', sans-serif;
      }

      .nav-links a:hover, .nav-links button:hover {
          background: #f0f0f0;
      }

      .nav-user {
        color: #333;
        padding: 10px 18px;
        border-radius: 8px;
        font-size: 15px;
        font-weight: 500;
        font-family: 'Poppins', sans-serif;
        cursor: default;
      }

      .nav-user:hover {
        background: #f0f0f0;
      }

      .hamburger-btn {
          font-size: 24px;
          padding: 8px 12px !important;
          background: transparent;
          border: none;
          cursor: pointer;
          color: #333;
      }

      .dropdown-menu {
          position: absolute;
          top: 60px;
          right: 0;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 24px rgba(0,0,0,0.15);
          padding: 10px;
          min-width: 200px;
          display: none; /* ·∫®n m·∫∑c ƒë·ªãnh */
          z-index: 1001;
      }

      .dropdown-menu.show {
          display: block;
          animation: fadeIn 0.2s ease;
      }

      .dropdown-menu a {
          display: block;
          padding: 12px 16px;
          color: #333;
          text-decoration: none;
          border-radius: 8px;
      }

      .dropdown-menu a:hover { background: #f0f0f0; }

      @keyframes fadeIn {
          from { opacity: 0; transform: translateY(-10px); }
          to { opacity: 1; transform: translateY(0); }
      }

      /* Buttons */
      .btn-primary {
          background: linear-gradient(135deg, #1C6758, #8EB486) !important; 
          color: white !important;
          padding: 12px 24px;
          border: none;
          border-radius: 50px;
          font-weight: 600;
          cursor: pointer;
          transition: 0.3s;
          box-shadow: 0 4px 15px rgba(0,0,0,0.1);
          display: inline-flex;
          align-items: center;
          gap: 8px;
          text-decoration: none;
      }

      .btn-primary:hover {
          transform: translateY(-2px);
          box-shadow: 0 6px 20px rgba(78, 205, 196, 0.4);
      }

      .btn-outline {
          background: white;
          border: 2px solid #1C6758;
          color: #1C6758;
          padding: 10px 20px;
          border-radius: 50px;
          font-weight: 600;
          cursor: pointer;
          transition: 0.3s;
          text-decoration: none;
          display: inline-block;
      }

      .btn-outline:hover {
          background: #1C6758;
          color: white;
      }

      /* --- DETAIL PAGE SPECIFIC STYLES --- */
      .container {
          max-width: 1200px;
          margin: 40px auto;
          padding: 0 20px;
      }

      .detail-layout {
          display: grid;
          grid-template-columns: 1fr 350px; /* C·ªôt tr√°i l·ªõn, c·ªôt ph·∫£i c·ªë ƒë·ªãnh */
          gap: 40px;
      }

      /* Left Column: Main Content */
      .main-content {
          background: white;
          border-radius: 20px;
          padding: 30px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      }

      .dest-title {
          font-size: 2.5em;
          color: #1C6758;
          margin-bottom: 10px;
      }

      .dest-meta {
          color: #666;
          margin-bottom: 20px;
          font-size: 0.95em;
          display: flex;
          gap: 15px;
          align-items: center;
      }

      .dest-image {
          width: 100%;
          height: 500px;
          object-fit: cover;
          border-radius: 15px;
          margin-bottom: 30px;
          box-shadow: 0 10px 30px rgba(0,0,0,0.1);
      }

      .dest-desc {
          font-size: 1.1em;
          line-height: 1.8;
          color: #444;
          white-space: pre-line;
          margin-bottom: 40px;
      }

      /* Feedback Section */
      .feedback-section {
          border-top: 1px solid #eee;
          padding-top: 30px;
      }

      .section-header {
          font-size: 1.5em;
          color: #333;
          margin-bottom: 20px;
          font-weight: 600;
      }

      .rating-box {
          background: #f9f9f9;
          padding: 20px;
          border-radius: 15px;
          margin-bottom: 30px;
          border: 1px solid #eee;
      }

      .rating-select {
          display: flex;
          gap: 10px;
          margin: 15px 0;
      }

      .rating-select span {
          font-size: 32px;
          cursor: pointer;
          color: #ddd;
          transition: 0.2s;
      }

      .rating-select span.active, .rating-select span:hover {
          color: #FFB800;
      }

      textarea {
          width: 100%;
          padding: 15px;
          border: 2px solid #e0e0e0;
          border-radius: 12px;
          font-family: inherit;
          resize: vertical;
          margin-bottom: 15px;
          transition: 0.3s;
      }

      textarea:focus {
          outline: none;
          border-color: #8EB486;
          background: white;
      }

      /* Review List */
      .review-list {
          display: flex;
          flex-direction: column;
          gap: 20px;
      }

      .review-item {
          background: white;
          padding: 20px;
          border-radius: 12px;
          border: 1px solid #eee;
          display: flex;
          gap: 15px;
      }

      .review-avatar {
          width: 50px;
          height: 50px;
          border-radius: 50%;
          background: linear-gradient(135deg, #8EB486, #1C6758);
          color: white;
          display: flex;
          align-items: center;
          justify-content: center;
          font-weight: 700;
          font-size: 18px;
          flex-shrink: 0;
      }

      .review-content h4 {
          margin-bottom: 5px;
          color: #333;
      }

      .user-rating { color: #FFB800; font-size: 14px; margin-bottom: 8px; }
      .review-text { color: #555; line-height: 1.5; }
      .review-date { font-size: 12px; color: #999; margin-top: 5px; }

      /* Right Sidebar */
      .sidebar {
          display: flex;
          flex-direction: column;
          gap: 25px;
      }

      .sidebar-card {
          background: white;
          padding: 25px;
          border-radius: 20px;
          box-shadow: 0 5px 20px rgba(0,0,0,0.05);
      }

      .sidebar-card h3 {
          color: #1C6758;
          margin-bottom: 15px;
          font-size: 1.2em;
          display: flex;
          align-items: center;
          gap: 10px;
      }

      .tag-cloud {
          display: flex;
          flex-wrap: wrap;
          gap: 8px;
      }

      .tag-pill {
          background: #f0fdf4;
          color: #1C6758;
          padding: 6px 14px;
          border-radius: 20px;
          font-size: 13px;
          font-weight: 500;
          border: 1px solid #d1fae5;
      }

      /* Weather Widget Styled */
      .weather-info {
          text-align: center;
      }

      .weather-main {
          font-size: 4em;
          margin: 10px 0;
      }

      .weather-temp {
          font-size: 2.5em;
          font-weight: 700;
          color: #333;
      }

      .weather-detail {
          color: #666;
          margin-bottom: 15px;
      }

      .forecast-btn {
          width: 100%;
          padding: 10px;
          background: #f5f5f5;
          border: none;
          border-radius: 10px;
          color: #555;
          font-weight: 600;
          cursor: pointer;
          transition: 0.3s;
      }

      .forecast-btn:hover { background: #e0e0e0; }

      .forecast-list {
          margin-top: 15px;
          display: none;
          border-top: 1px solid #eee;
          padding-top: 15px;
      }
      
      .forecast-list.show { display: block; }

      .forecast-item {
          display: flex;
          justify-content: space-between;
          padding: 8px 0;
          border-bottom: 1px dashed #eee;
          font-size: 14px;
      }

      /* Footer (Copy from Index) */
      footer {
          background: #2C3E50;
          color: white;
          padding: 50px 20px 20px;
          margin-top: 60px;
      }
      
      .footer-bottom {
          text-align: center;
          padding-top: 20px;
          border-top: 1px solid #444;
          color: #888;
          margin-top: 30px;
      }

      @media (max-width: 900px) {
          .detail-layout { grid-template-columns: 1fr; }
          .dest-image { height: 350px; }
      }
  </style>
</head>
<body>

  <div id="userInfo" data-user="{{ session.get('user_id', 0) }}"></div>

  <header>
      <div class="header-container">
          <a href="/" class="logo">Loca<span>Go!</span></a>
          <div class="nav-links">
              <a href="/MapRouting">B·∫£n ƒë·ªì du l·ªãch</a>
              <a href="/chat_ui">Chatbot du l·ªãch</a>
              <a href="/forum">Forum</a>
              <a href="/friends_map">Friends map</a>
              <div class="nav-links">
                {% if current_user.is_authenticated %}
                    <span class="nav-user">
                        Xin ch√†o, {{ current_user.username }}
                    </span>
                {%else %}
                    <a href="{{ url_for('login_bp.login') }}" class="btn-primary">ƒêƒÉng nh·∫≠p</a>
                {% endif %}
              <button class="hamburger-btn" onclick="toggleMenu()">
                  <i class="fas fa-bars"></i>
              </button>
              <div class="dropdown-menu" id="dropdownMenu">
                  <a href="{{ url_for('favorite_bp.list_favorites') }}"><i class="fas fa-heart"></i> Danh s√°ch y√™u th√≠ch</a>
                  <a href="/friends"><i class="fas fa-user-friends"></i> B·∫°n b√®</a>
                  {% if current_user.is_authenticated %}
                    <a href="{{ url_for('login_bp.logout') }}"><i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t</a>
                  {% endif %}
              </div>
          </div>
      </div>
  </header>

  <div class="container">
      <div style="margin-bottom: 20px;">
          <a href="/" class="btn-outline">
              <i class="fas fa-arrow-left"></i> Quay l·∫°i th∆∞ vi·ªán
          </a>
      </div>

      <div class="detail-layout">
          <div class="main-content">
              <h1 class="dest-title">{{ image.name }}</h1>
              <div class="dest-meta">
                  <span id="ratingDisplay">
                      <i class="fas fa-star" style="color: #FFB800;"></i> 
                      <b>{{ "%.1f"|format(image.rating or 0) }}</b> ({{ image.rating_count or 0 }} ƒë√°nh gi√°)
                  </span>
                  <span><i class="fas fa-map-marker-alt"></i> {{ image.city or 'Vi·ªát Nam' }}</span>
              </div>

              <img src="/static/images/{{ image.filename }}" alt="{{ image.name }}" class="dest-image"
                   onerror="this.src='https://via.placeholder.com/800x500?text=LocaGo'">

              <h3 class="section-header">Gi·ªõi thi·ªáu</h3>
              <div class="dest-desc">{{ image.description }}</div>

              <div class="feedback-section">
                  <h3 class="section-header">ƒê√°nh gi√° & Tr·∫£i nghi·ªám</h3>
                  
                  <div class="rating-box">
                      <p style="font-weight: 500;">Chia s·∫ª c·∫£m nh·∫≠n c·ªßa b·∫°n:</p>
                      <div class="rating-select" id="ratingSelect">
                          <span data-value="1"><i class="fas fa-star"></i></span>
                          <span data-value="2"><i class="fas fa-star"></i></span>
                          <span data-value="3"><i class="fas fa-star"></i></span>
                          <span data-value="4"><i class="fas fa-star"></i></span>
                          <span data-value="5"><i class="fas fa-star"></i></span>
                      </div>
                      <input type="hidden" id="ratingInput" value="0">
                      
                      <textarea id="comment" rows="3" placeholder="Kh√¥ng gian th·∫ø n√†o? D·ªãch v·ª• ra sao? H√£y chia s·∫ª nh√©..."></textarea>
                      
                      <button id="sendBtn" class="btn-primary">
                          <i class="fas fa-paper-plane"></i> G·ª≠i ƒë√°nh gi√°
                      </button>
                  </div>

                  <div id="feedbackList" class="review-list">
                      <div style="text-align:center; color:#999;">ƒêang t·∫£i b√¨nh lu·∫≠n...</div>
                  </div>
              </div>
          </div>

          <div class="sidebar">
              <div class="sidebar-card">
                  <h3><i class="fas fa-bookmark"></i> H√†nh ƒë·ªông</h3>
                  <button id="addFavoriteBtn" class="btn-primary" style="width: 100%; justify-content: center;">
                      <i class="far fa-heart"></i> Th√™m v√†o y√™u th√≠ch
                  </button>
                  <hr style="margin: 15px 0; border: 0; border-top: 1px solid #eee;">
                  <div class="tag-cloud">
                      <span style="width: 100%; font-size: 14px; color: #666; margin-bottom: 5px;">Tags:</span>
                      {% if image.tags %}
                        {% for tag in image.tags.split(',') %}
                            <span class="tag-pill">{{ tag.strip() }}</span>
                        {% endfor %}
                      {% else %}
                        <span class="tag-pill">Du l·ªãch</span>
                      {% endif %}
                  </div>
              </div>

              <div class="sidebar-card">
                  <h3><i class="fas fa-cloud-sun"></i> Th·ªùi ti·∫øt hi·ªán t·∫°i</h3>
                  <div class="weather-info" id="weatherWidget">
                      <div id="w-icon" class="weather-main">‚ùì</div>
                      <div id="w-temp" class="weather-temp">--¬∞C</div>
                      <div id="w-wind" class="weather-detail">--</div>
                      <div id="w-time" class="weather-detail" style="font-size: 12px;">--</div>
                      
                      <button class="forecast-btn" onclick="toggleForecast()">
                          Xem d·ª± b√°o 7 ng√†y <i class="fas fa-chevron-down"></i>
                      </button>

                      <div id="forecastContent" class="forecast-list">
                          ƒêang t·∫£i d·ªØ li·ªáu...
                      </div>
                  </div>
              </div>
          </div>
      </div>
  </div>

  <footer>
      <div class="footer-bottom">
          <p>¬© 2025 LocaGo! - Designed with ‚ù§Ô∏è for travelers</p>
      </div>
  </footer>

  <script>
    function toggleMenu() {
          const menu = document.getElementById('dropdownMenu');
          menu.classList.toggle('show');
      }

      // ƒê√≥ng menu khi click ra ngo√†i
      document.addEventListener('click', function(event) {
          const menu = document.getElementById('dropdownMenu');
          const hamburger = document.querySelector('.hamburger-btn');
          
          if (menu && hamburger && !menu.contains(event.target) && !hamburger.contains(event.target)) {
              menu.classList.remove('show');
          }
      });
    // ===== 1. LOGIC ƒê√ÅNH GI√Å (RATING) =====
    let currentRating = 0;
    const stars = document.querySelectorAll("#ratingSelect span");
    const ratingInput = document.getElementById("ratingInput");

    stars.forEach(s => {
      s.addEventListener("click", () => {
        currentRating = parseInt(s.dataset.value);
        if (ratingInput) ratingInput.value = currentRating;
        
        stars.forEach(x => x.classList.remove("active"));
        for (let i = 0; i < currentRating; i++) stars[i].classList.add("active");
      });
    });

    // ===== 2. X·ª¨ L√ù G·ª¨I B√åNH LU·∫¨N (GEOLOCATION) =====
    document.getElementById("sendBtn").addEventListener("click", () => {
        initiateFeedbackSubmission();
    });

    function initiateFeedbackSubmission() {
        const imageId = Number("{{ image.id }}");
        const userInfo = document.getElementById("userInfo");
        const userId = userInfo ? Number(userInfo.dataset.user) : 0;
        const rating = Number(document.getElementById("ratingInput").value);
        const comment = document.getElementById("comment").value;

        if (!userId) {
            alert("B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ vi·∫øt ƒë√°nh gi√°.");
            // window.location.href = "/login"; // B·ªè comment n·∫øu mu·ªën redirect
            return;
        }

        if (rating === 0 || isNaN(rating)) {
            alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë·ªÉ ƒë√°nh gi√°.");
            return;
        }

        if (navigator.geolocation) {
            // Hi·ªÉn th·ªã tr·∫°ng th√°i loading cho n√∫t
            const btn = document.getElementById("sendBtn");
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang g·ª≠i...';
            btn.disabled = true;

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    sendFeedbackToServer(imageId, userId, rating, comment, lat, lng, btn, originalText);
                },
                (error) => {
                    alert("Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠. Vui l√≤ng c·∫•p quy·ªÅn v·ªã tr√≠ ƒë·ªÉ x√°c th·ª±c review.");
                    console.error(error);
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                },
                { enableHighAccuracy: true, timeout: 10000 }
            );
        } else {
            alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation.");
        }
    }

    async function sendFeedbackToServer(imageId, userId, rating, comment, lat, lng, btn, originalText) {
        try {
            const res = await fetch(`/feedback/${imageId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ user_id: userId, rating, comment, lat, lng }),
            });

            const result = await res.json();

            if (res.ok) {
                alert("C·∫£m ∆°n b·∫°n! ƒê√°nh gi√° ƒë√£ ƒë∆∞·ª£c g·ª≠i.");
                loadFeedback(); 
                // Reset form
                document.getElementById("comment").value = "";
                stars.forEach(x => x.classList.remove("active"));
                ratingInput.value = 0;
                
                // C·∫≠p nh·∫≠t ƒëi·ªÉm s·ªë hi·ªÉn th·ªã ngay l·∫≠p t·ª©c (Optional)
                 if(result.new_rating) {
                     document.getElementById("ratingDisplay").innerHTML = 
                        `<i class="fas fa-star" style="color: #FFB800;"></i> <b>${result.new_rating.toFixed(1)}</b> (${result.rating_count} ƒë√°nh gi√°)`;
                 }

            } else {
                alert(`L·ªói: ${result.error || 'Kh√¥ng th·ªÉ g·ª≠i ƒë√°nh gi√°'}`);
            }
        } catch (error) {
            console.error(error);
            alert("L·ªói k·∫øt n·ªëi server.");
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    // ===== 3. T·∫¢I DANH S√ÅCH B√åNH LU·∫¨N =====
    async function loadFeedback() {
      const imageId = Number("{{ image.id }}");
      const listDiv = document.getElementById("feedbackList");
      
      try {
          const res = await fetch(`/feedback/${imageId}`);
          const data = await res.json();
          
          if(!data.feedback || data.feedback.length === 0) {
              listDiv.innerHTML = '<div style="text-align:center; padding:20px; background:#f9f9f9; border-radius:10px;">Ch∆∞a c√≥ ƒë√°nh gi√° n√†o. H√£y l√† ng∆∞·ªùi ƒë·∫ßu ti√™n!</div>';
              return;
          }

          let html = "";
          data.feedback.forEach(fb => {
            // T·∫°o avatar ch·ªØ c√°i ƒë·∫ßu
            const initial = fb.username ? fb.username.charAt(0).toUpperCase() : '?';
            
            html += `
              <div class="review-item">
                <div class="review-avatar">${initial}</div>
                <div class="review-content" style="flex:1;">
                    <div style="display:flex; justify-content:space-between;">
                        <h4>${fb.username}</h4>
                        <div class="user-rating">
                            ${'<i class="fas fa-star"></i>'.repeat(fb.rating)}
                        </div>
                    </div>
                    <div class="review-text">${fb.comment}</div>
                    <div class="review-date">${fb.timestamp || ''}</div>
                </div>
              </div>
            `;
          });
          listDiv.innerHTML = html;
      } catch (e) {
          listDiv.innerHTML = "L·ªói t·∫£i b√¨nh lu·∫≠n.";
      }
    }
    
    loadFeedback();

    // ===== 4. Y√äU TH√çCH =====
    document.getElementById("addFavoriteBtn").addEventListener("click", async function() {
      const imageId = Number("{{ image.id }}");
      const icon = this.querySelector('i');
      
      try {
          const res = await fetch(`/favorite/${imageId}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" }
          });
          const result = await res.json();

          if (res.ok) {
            icon.classList.remove('far');
            icon.classList.add('fas');
            alert("ƒê√£ th√™m v√†o b·ªô s∆∞u t·∫≠p c·ªßa b·∫°n!");
          } else {
             if(result.login_url) window.location.href = result.login_url;
             else alert(result.error);
          }
      } catch(e) { console.error(e); }
    });

    // ===== 5. WEATHER WIDGET LOGIC =====
    function getWeatherIcon(code) {
        if (code == 0) return "‚òÄÔ∏è";
        if (code <= 3) return "‚òÅÔ∏è";
        if (code <= 48) return "üå´Ô∏è";
        if (code <= 57) return "üå¶Ô∏è";
        if (code <= 67) return "üåßÔ∏è";
        if (code <= 77) return "‚ùÑÔ∏è";
        if (code <= 99) return "‚õàÔ∏è";
        return "‚ùì";
    }

    async function loadCurrentWeather(placeId) {
        try {
            const res = await fetch(`/weather/${placeId}`);
            const data = await res.json();
            
            if (!res.ok || !data.current_weather) return;

            const c = data.current_weather;
            document.getElementById("w-icon").innerHTML = getWeatherIcon(c.weathercode);
            document.getElementById("w-temp").innerHTML = `${c.temperature}¬∞C`;
            document.getElementById("w-wind").innerHTML = `üí® Gi√≥: ${c.windspeed} km/h`;
            document.getElementById("w-time").innerHTML = `C·∫≠p nh·∫≠t: ${c.time.split('T')[1]}`;
        } catch (err) { console.error(err); }
    }

    function toggleForecast() {
        const div = document.getElementById("forecastContent");
        div.classList.toggle("show");
        if(div.classList.contains("show")) {
            loadForecast();
        }
    }

    function loadForecast() {
        fetch(`/forecast/{{ image.id }}`)
        .then(r => r.json())
        .then(data => {
            if(!data.daily) return;
            let html = "";
            for (let i = 0; i < Math.min(7, data.daily.time.length); i++) {
                html += `
                    <div class="forecast-item">
                        <span>${data.daily.time[i]}</span>
                        <span>
                            <span style="color:#ff6b6b">H: ${data.daily.temperature_2m_max[i]}¬∞</span> / 
                            <span style="color:#4ecdc4">L: ${data.daily.temperature_2m_min[i]}¬∞</span>
                        </span>
                    </div>
                `;
            }
            document.getElementById("forecastContent").innerHTML = html;
        });
    }

    loadCurrentWeather({{ image.id }});
  </script>
</body>
</html>