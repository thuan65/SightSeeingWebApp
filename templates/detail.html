<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ image.name }}</title>

  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; line-height: 1.6; }
    img { width: 100%; height: auto; border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 20px; }
    .desc { text-align: left; white-space: pre-line; }

    .feedback-box { margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px; }
    .feedback-item { background: #f3f3f3; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
    .rating-stars { color: #ffb400; font-size: 20px; margin-bottom: 5px; }

    .rating-select span {
      font-size: 28px;
      cursor: pointer;
      color: #ccc;
    }
    .rating-select span.active {
      color: gold;
    }
  </style>
</head>
<body>
  <div id="userInfo" data-user="{{ session.get('user_id', 0) }}"></div>

  <h1>{{ image.name }}</h1>

  <img src="/static/images/{{ image.filename }}" alt="{{ image.name }}">

  <p><b>Tags:</b> {{ image.tags }}</p>
  <div class="desc">{{ image.description }}</div>

  <p><a href="/">‚¨Ö Quay l·∫°i th∆∞ vi·ªán</a></p>

<button id="addFavoriteBtn"
        style="padding:10px 16px; font-size:16px; cursor:pointer; margin-bottom:20px;">
  ‚ù§Ô∏è Th√™m v√†o danh s√°ch y√™u th√≠ch
</button>

    <div class="feedback-box">
    <h2>ƒê√°nh gi√° & B√¨nh lu·∫≠n</h2>

        <p id="ratingStats">
      ‚≠ê <b>{{ "%.1f"|format(image.rating or 0) }}</b>
      ({{ image.rating_count or 0 }} ƒë√°nh gi√°)
    </p>

        <div class="rating-select" id="ratingSelect">
      <span data-value="1">‚òÖ</span>
      <span data-value="2">‚òÖ</span>
      <span data-value="3">‚òÖ</span>
      <span data-value="4">‚òÖ</span>
      <span data-value="5">‚òÖ</span>
    </div>
    <input type="hidden" id="ratingInput" value="0">

        <textarea id="comment" placeholder="Vi·∫øt c·∫£m nh·∫≠n..."
              rows="3" style="width:100%; margin-top:10px; padding:10px"></textarea>

    <button id="sendBtn"
            style="margin-top:10px; padding:10px 16px; font-size:16px; cursor:pointer;">
      G·ª≠i ƒë√°nh gi√°
    </button>

    <h3 style="margin-top:30px">C√°c b√¨nh lu·∫≠n g·∫ßn ƒë√¢y</h3>
    <div id="feedbackList">ƒêang t·∫£i...</div>
  </div>

  <!-- ===== WEATHER WIDGET ===== -->
  <div id="weatherWidget" 
     style="position: fixed; bottom: 20px; right: 20px; width: 200px; 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); 
            border-radius: 16px; padding: 12px; text-align: center; cursor: pointer; z-index:999;">
    <div id="w-icon" class="text-4xl mb-1"></div>
    <div id="w-temp" class="font-bold text-xl"></div>
    <div id="w-wind" class="text-sm opacity-80 mb-1"></div>
    <div id="w-time" class="text-sm opacity-80 mb-1"></div>
    <div style="font-size:12px; opacity:0.7;">Nh·∫•n ƒë·ªÉ xem d·ª± b√°o</div>
  </div>

<!-- D·ª∞ B√ÅO 7 NG√ÄY (·∫©n m·∫∑c ƒë·ªãnh) -->
  <div id="weatherForecast" 
     style="display:none; position: fixed; bottom: 20px; right: 240px; width: 300px; 
            max-height: 400px; overflow-y:auto; background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(10px); border-radius:16px; padding:12px; z-index:999;">
    <h3 style="text-align:center; margin-bottom:10px;">D·ª± b√°o 7 ng√†y</h3>
    <div id="forecastContent"></div>
  </div>

  <script>
    // ===== SELECT RATING =====
    let currentRating = 0;
    const stars = document.querySelectorAll("#ratingSelect span");

    const ratingInput = document.getElementById("ratingInput");
    stars.forEach(s => {
      s.addEventListener("click", () => {
        currentRating = parseInt(s.dataset.value);
        if (ratingInput) {
            ratingInput.value = currentRating;
        }
        stars.forEach(x => x.classList.remove("active"));
        for (let i = 0; i < currentRating; i++) stars[i].classList.add("active");
      });
    });


    // ===== SUBMIT FEEDBACK (ƒê√É S·ª¨A) =====
      document.getElementById("sendBtn").addEventListener("click", () => {
        initiateFeedbackSubmission();
      });

      // ===== H√ÄM M·ªöI: XIN C·∫§P QUY·ªÄN V√Ä G·ª¨I T·ªåA ƒê·ªò =====
      function initiateFeedbackSubmission() {
        const imageId = Number("{{ image.id }}");
        const userId = Number(document.getElementById("userInfo").dataset.user);
        const rating = Number(document.getElementById("ratingInput").value);
        const comment = document.getElementById("comment").value;

      if (!userId) {
            alert("Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë√°nh gi√°.");
            window.location.href = "/login";
            return;
      }

        if (rating === 0 || isNaN(rating)) {
          console.log("[DEBUG FE] 2. L·ªói: Rating b·ªã thi·∫øu ho·∫∑c b·∫±ng 0."); // <--- DEBUG 2
            alert("Vui l√≤ng ch·ªçn s·ªë sao (ƒë√°nh gi√°) b·∫Øt bu·ªôc tr∆∞·ªõc khi g·ª≠i.");
            return;
        }

        // B·∫Øt ƒë·∫ßu qu√° tr√¨nh l·∫•y v·ªã tr√≠
        if (navigator.geolocation) {
          console.log("[DEBUG FE] 3. Geolocation ƒë∆∞·ª£c h·ªó tr·ª£."); // <--- DEBUG 3
            alert("Web s·∫Ω y√™u c·∫ßu quy·ªÅn truy c·∫≠p v·ªã tr√≠ c·ªßa b·∫°n ƒë·ªÉ x√°c minh. Vui l√≤ng ch·∫•p nh·∫≠n.");
            navigator.geolocation.getCurrentPosition(
                // Success: C√≥ ƒë∆∞·ª£c v·ªã tr√≠
                (position) => {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;

                    // G·ª≠i feedback v·ªõi t·ªça ƒë·ªô
                    sendFeedbackToServer(imageId, userId, rating, comment, lat, lng);
                },
                // Error: Kh√¥ng c√≥ ƒë∆∞·ª£c v·ªã tr√≠ (ng∆∞·ªùi d√πng t·ª´ ch·ªëi/timeout)
                (error) => {
                    let errorMessage = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ c·ªßa b·∫°n. ";
                    if (error.code === 1) {
                        errorMessage += "Vui l√≤ng c·∫•p quy·ªÅn truy c·∫≠p v·ªã tr√≠ (Location) ƒë·ªÉ ƒë√°nh gi√°.";
                    } else {
                        errorMessage += "L·ªói k·ªπ thu·∫≠t GPS. Vui l√≤ng th·ª≠ l·∫°i.";
                    }
                    alert(errorMessage);
                    console.error("Geolocation Error:", error);
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
          console.log("[DEBUG FE] 4. L·ªói: Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation."); // <--- DEBUG 4
            alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã GPS.");
        }
    }

    // ===== H√ÄM M·ªöI: G·ª¨I D·ªÆ LI·ªÜU ƒê·∫æN SERVER =====
    async function sendFeedbackToServer(imageId, userId, rating, comment, lat, lng) {
        // G·ª≠i t·ªça ƒë·ªô ng∆∞·ªùi d√πng l√™n server
        try {
            const res = await fetch(`/feedback/${imageId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    user_id: userId,
                    rating: rating,
                    comment: comment,
                    lat: lat,
                    lng: lng // G·ª≠i t·ªça ƒë·ªô ng∆∞·ªùi d√πng
                }),
            });

            const result = await res.json();

            if (res.ok) {
                alert("ƒê√°nh gi√° c·ªßa b·∫°n ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng!");
                loadFeedback(); 
                updateRatingStats(result.new_rating, result.rating_count);
                // 3. D·ªçn d·∫πp giao di·ªán
                document.getElementById("comment").value = "";
                stars.forEach(x => x.classList.remove("active"));
                currentRating = 0;
            } else if (res.status === 400 || res.status === 403 || res.status === 404 || res.status === 401) {
                // X·ª≠ l√Ω c√°c l·ªói t·ª´ BE (Bao g·ªìm l·ªói 403: Qu√° xa)
                alert(`Th·∫•t b·∫°i: ${result.error}`);
            } else {
                alert(`L·ªói h·ªá th·ªëng kh√¥ng x√°c ƒë·ªãnh: ${res.statusText}`);
            }
        } catch (error) {
            console.error("Submission Error:", error);
            alert("C√≥ l·ªói x·∫£y ra trong qu√° tr√¨nh g·ª≠i ƒë√°nh gi√°.");
        }
    }
    // ===== H√ÄM M·ªöI: C·∫¨P NH·∫¨T CH·ªà S·ªê RATING T·ªîNG =====
    function updateRatingStats(rating, count) {
      const statsElement = document.getElementById("ratingStats");
      const formattedRating = rating.toFixed(1);
      statsElement.innerHTML = `
        ‚≠ê <b>${formattedRating}</b>
        (${count} ƒë√°nh gi√°)
      `;
    }


    // ===== LOAD FEEDBACK LIST (GI·ªÆ NGUY√äN) =====
    async function loadFeedback() {
      const imageId = Number("{{ image.id }}");  /* FIXED */
      const res = await fetch(`/feedback/${imageId}`);
      const feedbackData = await res.json();     /* FIXED */

      let html = "";
      feedbackData.feedback.forEach(fb => {
        html += `
          <div class="feedback-item">
            <div><b>${fb.username}</b></div>
            <div class="rating-stars">${"‚òÖ".repeat(fb.rating)}</div>
            <div>${fb.comment}</div>
            <div style="font-size:13px; color:#666;">${fb.timestamp}</div>
          </div>
        `;
      });

      document.getElementById("feedbackList").innerHTML =
        html || "Ch∆∞a c√≥ ƒë√°nh gi√° n√†o.";
    }

    loadFeedback();

      // yeu thich
    document.getElementById("addFavoriteBtn").addEventListener("click", async () => {
      const imageId = Number("{{ image.id }}");

      const res = await fetch(`/favorite/${imageId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();

      if (res.ok) {
        alert("ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch!");
      } else {
        if (result.login_url) {
          // Ch∆∞a login ‚Üí redirect t·ªõi login
          window.location.href = result.login_url;
        } else {
          alert("L·ªói: " + result.error);
        }
      }
    });

  </script>

  <script>

    function getWeatherIcon(code) {
        if (code == 0) return "‚òÄÔ∏è";
        if (code <= 3) return "‚òÅÔ∏è";
        if (code <= 48) return "üå´Ô∏è";
        if (code <= 57) return "üå¶Ô∏è";
        if (code <= 67) return "üåßÔ∏è";
        if (code <= 77) return "‚ùÑÔ∏è";
        if (code <= 99) return "‚õàÔ∏è";
        return "‚ùì";
    }

      // ===== LOAD CURRENT WEATHER =====
  async function loadCurrentWeather(placeId) {
    try {
        const res = await fetch(`/weather/${placeId}`);
        const data = await res.json();

        if (!res.ok || !data.current_weather) {
            console.error("Weather data missing", data);
            document.getElementById("w-icon").innerHTML = "‚ùì";
            document.getElementById("w-temp").innerHTML = "--";
            document.getElementById("w-wind").innerHTML = "--";
            document.getElementById("w-time").innerHTML = "--";
            return;
        }

        const c = data.current_weather;
        document.getElementById("w-icon").innerHTML = getWeatherIcon(c.weathercode);
        document.getElementById("w-temp").innerHTML = `${c.temperature}¬∞C`;
        document.getElementById("w-wind").innerHTML = `üí® Gi√≥: ${c.windspeed} km/h`;
        document.getElementById("w-time").innerHTML = `‚è± ${c.time}`;

    } catch (err) {
        console.error(err);
    }
}



    // ===== LOAD FORECAST =====
    function loadForecast(placeId) {
        fetch(`/forecast/{{ image.id }}`)
        .then(r => r.json())
        .then(data => {
            let html = "";
            for (let i = 0; i < data.daily.time.length; i++) {
                html += `
                    <div style="padding:6px; margin-bottom:6px; border-radius:10px; background: rgba(255,255,255,0.1);">
                        <div><b>${data.daily.time[i]}</b></div>
                        <div>üå° Max: ${data.daily.temperature_2m_max[i]}¬∞C</div>
                        <div>üå° Min: ${data.daily.temperature_2m_min[i]}¬∞C</div>
                        <div>üíß M∆∞a: ${data.daily.precipitation_sum[i]} mm</div>
                    </div>
                `;
            }
            document.getElementById("forecastContent").innerHTML = html;
        });
    }

  document.getElementById("weatherWidget").addEventListener("click", () => {
      const f = document.getElementById("weatherForecast");
      f.style.display = f.style.display === "none" ? "block" : "none";
      if (f.style.display === "block") {
          loadForecast({{ image.id }});
      }
  });

  loadCurrentWeather({{ image.id }});


  </script>

</body>
</html>
