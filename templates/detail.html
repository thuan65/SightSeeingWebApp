<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>{{ image.name }}</title>

  <style>
    body { font-family: sans-serif; max-width: 800px; margin: 40px auto; line-height: 1.6; }
    img { width: 100%; height: auto; border-radius: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.3); margin-bottom: 20px; }
    .desc { text-align: left; white-space: pre-line; }

    .feedback-box { margin-top: 30px; border-top: 2px solid #ccc; padding-top: 20px; }
    .feedback-item { background: #f3f3f3; padding: 12px; border-radius: 8px; margin-bottom: 10px; }
    .rating-stars { color: #ffb400; font-size: 20px; margin-bottom: 5px; }

    .rating-select span {
      font-size: 28px;
      cursor: pointer;
      color: #ccc;
    }
    .rating-select span.active {
      color: gold;
    }
  </style>
</head>
<body>
  <div id="userInfo" data-user="{{ session.get('user_id', 0) }}"></div>

  <h1>{{ image.name }}</h1>

  <img src="/static/images/{{ image.filename }}" alt="{{ image.name }}">

  <p><b>Tags:</b> {{ image.tags }}</p>
  <div class="desc">{{ image.description }}</div>

  <p><a href="/">â¬… Quay láº¡i thÆ° viá»‡n</a></p>

<button id="addFavoriteBtn"
        style="padding:10px 16px; font-size:16px; cursor:pointer; margin-bottom:20px;">
  â¤ï¸ ThÃªm vÃ o danh sÃ¡ch yÃªu thÃ­ch
</button>

    <div class="feedback-box">
    <h2>ÄÃ¡nh giÃ¡ & BÃ¬nh luáº­n</h2>

        <p id="ratingStats">
      â­ <b>{{ "%.1f"|format(image.rating or 0) }}</b>
      ({{ image.rating_count or 0 }} Ä‘Ã¡nh giÃ¡)
    </p>

        <div class="rating-select" id="ratingSelect">
      <span data-value="1">â˜…</span>
      <span data-value="2">â˜…</span>
      <span data-value="3">â˜…</span>
      <span data-value="4">â˜…</span>
      <span data-value="5">â˜…</span>
    </div>

        <textarea id="comment" placeholder="Viáº¿t cáº£m nháº­n..."
              rows="3" style="width:100%; margin-top:10px; padding:10px"></textarea>

    <button id="sendBtn"
            style="margin-top:10px; padding:10px 16px; font-size:16px; cursor:pointer;">
      Gá»­i Ä‘Ã¡nh giÃ¡
    </button>

    <h3 style="margin-top:30px">CÃ¡c bÃ¬nh luáº­n gáº§n Ä‘Ã¢y</h3>
    <div id="feedbackList">Äang táº£i...</div>
  </div>

  <!-- ===== WEATHER WIDGET ===== -->
  <div id="weatherWidget" 
     style="position: fixed; bottom: 20px; right: 20px; width: 200px; 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); 
            border-radius: 16px; padding: 12px; text-align: center; cursor: pointer; z-index:999;">
    <div id="w-icon" class="text-4xl mb-1"></div>
    <div id="w-temp" class="font-bold text-xl"></div>
    <div id="w-wind" class="text-sm opacity-80 mb-1"></div>
    <div id="w-time" class="text-sm opacity-80 mb-1"></div>
    <div style="font-size:12px; opacity:0.7;">Nháº¥n Ä‘á»ƒ xem dá»± bÃ¡o</div>
  </div>

<!-- Dá»° BÃO 7 NGÃ€Y (áº©n máº·c Ä‘á»‹nh) -->
  <div id="weatherForecast" 
     style="display:none; position: fixed; bottom: 20px; right: 240px; width: 300px; 
            max-height: 400px; overflow-y:auto; background: rgba(255,255,255,0.2); 
            backdrop-filter: blur(10px); border-radius:16px; padding:12px; z-index:999;">
    <h3 style="text-align:center; margin-bottom:10px;">Dá»± bÃ¡o 7 ngÃ y</h3>
    <div id="forecastContent"></div>
  </div>

  <script>
    // ===== SELECT RATING =====
    let currentRating = 0;
    const stars = document.querySelectorAll("#ratingSelect span");

    stars.forEach(s => {
      s.addEventListener("click", () => {
        currentRating = parseInt(s.dataset.value);
        stars.forEach(x => x.classList.remove("active"));
        for (let i = 0; i < currentRating; i++) stars[i].classList.add("active");
      });
    });


    // ===== SUBMIT FEEDBACK (ÄÃƒ Sá»¬A) =====
    document.getElementById("sendBtn").addEventListener("click", async () => {
      if (currentRating === 0) {
        alert("Báº¡n chÆ°a chá»n sá»‘ sao!");
        return;
      }

      const comment = document.getElementById("comment").value;
      const imageId = Number("{{ image.id }}");  /* FIXED */
      const currentUserId = Number(document.getElementById("userInfo").dataset.user);


      const res = await fetch(`/feedback/${imageId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          user_id: currentUserId,
          rating: currentRating,
          comment: comment
        })
      });

      const result = await res.json();   /* FIXED */

      if (res.ok) {
        alert("Gá»­i Ä‘Ã¡nh giÃ¡ thÃ nh cÃ´ng!");
        
        // 1. Táº£i láº¡i danh sÃ¡ch feedback má»›i nháº¥t
        loadFeedback(); 
        
        // 2. Cáº­p nháº­t chá»‰ sá»‘ rating tá»•ng thá»ƒ
        updateRatingStats(result.new_rating, result.rating_count);
        
        // 3. Dá»n dáº¹p giao diá»‡n
        document.getElementById("comment").value = "";
        stars.forEach(x => x.classList.remove("active"));
        currentRating = 0;
      } else {
        alert("Lá»—i: " + result.error);
      }
    });

    // ===== HÃ€M Má»šI: Cáº¬P NHáº¬T CHá»ˆ Sá» RATING Tá»”NG =====
    function updateRatingStats(rating, count) {
      const statsElement = document.getElementById("ratingStats");
      const formattedRating = rating.toFixed(1);
      statsElement.innerHTML = `
        â­ <b>${formattedRating}</b>
        (${count} Ä‘Ã¡nh giÃ¡)
      `;
    }


    // ===== LOAD FEEDBACK LIST (GIá»® NGUYÃŠN) =====
    async function loadFeedback() {
      const imageId = Number("{{ image.id }}");  /* FIXED */
      const res = await fetch(`/feedback/${imageId}`);
      const feedbackData = await res.json();     /* FIXED */

      let html = "";
      feedbackData.feedback.forEach(fb => {
        html += `
          <div class="feedback-item">
            <div><b>${fb.username}</b></div>
            <div class="rating-stars">${"â˜…".repeat(fb.rating)}</div>
            <div>${fb.comment}</div>
            <div style="font-size:13px; color:#666;">${fb.timestamp}</div>
          </div>
        `;
      });

      document.getElementById("feedbackList").innerHTML =
        html || "ChÆ°a cÃ³ Ä‘Ã¡nh giÃ¡ nÃ o.";
    }

    loadFeedback();

      // yeu thich
    document.getElementById("addFavoriteBtn").addEventListener("click", async () => {
      const imageId = Number("{{ image.id }}");

      const res = await fetch(`/favorite/${imageId}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      const result = await res.json();

      if (res.ok) {
        alert("ÄÃ£ thÃªm vÃ o danh sÃ¡ch yÃªu thÃ­ch!");
      } else {
        if (result.login_url) {
          // ChÆ°a login â†’ redirect tá»›i login
          window.location.href = result.login_url;
        } else {
          alert("Lá»—i: " + result.error);
        }
      }
    });

  </script>

  <script>

    function getWeatherIcon(code) {
        if (code == 0) return "â˜€ï¸";
        if (code <= 3) return "â˜ï¸";
        if (code <= 48) return "ğŸŒ«ï¸";
        if (code <= 57) return "ğŸŒ¦ï¸";
        if (code <= 67) return "ğŸŒ§ï¸";
        if (code <= 77) return "â„ï¸";
        if (code <= 99) return "â›ˆï¸";
        return "â“";
    }

      // ===== LOAD CURRENT WEATHER =====
  async function loadCurrentWeather(placeId) {
    try {
        const res = await fetch(`/weather/${placeId}`);
        const data = await res.json();

        if (!res.ok || !data.current_weather) {
            console.error("Weather data missing", data);
            document.getElementById("w-icon").innerHTML = "â“";
            document.getElementById("w-temp").innerHTML = "--";
            document.getElementById("w-wind").innerHTML = "--";
            document.getElementById("w-time").innerHTML = "--";
            return;
        }

        const c = data.current_weather;
        document.getElementById("w-icon").innerHTML = getWeatherIcon(c.weathercode);
        document.getElementById("w-temp").innerHTML = `${c.temperature}Â°C`;
        document.getElementById("w-wind").innerHTML = `ğŸ’¨ GiÃ³: ${c.windspeed} km/h`;
        document.getElementById("w-time").innerHTML = `â± ${c.time}`;

    } catch (err) {
        console.error(err);
    }
}



    // ===== LOAD FORECAST =====
    function loadForecast(placeId) {
        fetch(`/forecast/{{ image.id }}`)
        .then(r => r.json())
        .then(data => {
            let html = "";
            for (let i = 0; i < data.daily.time.length; i++) {
                html += `
                    <div style="padding:6px; margin-bottom:6px; border-radius:10px; background: rgba(255,255,255,0.1);">
                        <div><b>${data.daily.time[i]}</b></div>
                        <div>ğŸŒ¡ Max: ${data.daily.temperature_2m_max[i]}Â°C</div>
                        <div>ğŸŒ¡ Min: ${data.daily.temperature_2m_min[i]}Â°C</div>
                        <div>ğŸ’§ MÆ°a: ${data.daily.precipitation_sum[i]} mm</div>
                    </div>
                `;
            }
            document.getElementById("forecastContent").innerHTML = html;
        });
    }

  document.getElementById("weatherWidget").addEventListener("click", () => {
      const f = document.getElementById("weatherForecast");
      f.style.display = f.style.display === "none" ? "block" : "none";
      if (f.style.display === "block") {
          loadForecast({{ image.id }});
      }
  });

  loadCurrentWeather({{ image.id }});


  </script>

</body>
</html>
