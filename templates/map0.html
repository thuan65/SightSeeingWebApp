<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Báº£n Ä‘á»“ chá»‰ Ä‘Æ°á»ng thÃ´ng minh</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }

    .input-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
      background: white;
      border-radius: 50px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      align-items: center;
    }

    input, select {
      padding: 8px 15px;
      border: 2px solid #1C6758;
      border-radius: 50px;
      outline: none;
      font-size: 14px;
    }

    button {
      padding: 8px 18px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(90deg,#1C6758,#8EB486);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    #info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 18px 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      font-size: 16px;
      z-index: 1000;
      min-width: 350px;
      text-align: center;
    }

    #info b {
      font-size: 17px;
      color: #1C6758;
    }

    .route-info {
      margin: 8px 0;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .route-info:last-child {
      border-bottom: none;
    }

  </style>
</head>
<body>

  <div class="input-container">
    <input id="start" type="text" placeholder="Äiá»ƒm báº¯t Ä‘áº§u (VD: TP. Há»“ ChÃ­ Minh)">
    <input id="end" type="text" placeholder="Äiá»ƒm káº¿t thÃºc (VD: HÃ  Ná»™i)">
    
    <select id="mode">
      <option value="car">ğŸš— Xe hÆ¡i</option>
      <option value="motorcycle">ğŸï¸ Xe mÃ¡y</option>
      <option value="foot">ğŸš¶ Äi bá»™</option>
    </select>

    <button onclick="findRoute()">Chá»‰ Ä‘Æ°á»ng</button>
  </div>

  <div id="map"></div>
  <div id="info"></div>

  <script>
    // Khá»Ÿi táº¡o báº£n Ä‘á»“
    const map = L.map('map').setView([10.762622, 106.660172], 13);

    // ThÃªm ná»n báº£n Ä‘á»“
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let routeLayers = [];
    let startMarker, endMarker;

    // HÃ m láº¥y tá»a Ä‘á»™ tá»« Ä‘á»‹a chá»‰
    async function getCoordinates(address) {
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}, Vietnam&format=json&limit=1`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.length === 0) return null;
      const { lat, lon, display_name } = data[0];
      if (!display_name.includes("Vietnam") && !display_name.includes("Viá»‡t Nam")) {
        alert(`âš ï¸ Äá»‹a chá»‰ "${address}" khÃ´ng náº±m trong Viá»‡t Nam!`);
        return null;
      }
      return [parseFloat(lat), parseFloat(lon)];
    }

    // HÃ m tÃ¬m Ä‘Æ°á»ng
    async function findRoute() {
      const start = document.getElementById("start").value.trim();
      const end = document.getElementById("end").value.trim();
      const mode = document.getElementById("mode").value;
      const apiKey = "510b2242-84d4-45c2-97fa-baa242e6a4b7";

      if (!start || !end) {
        alert("Vui lÃ²ng nháº­p Ä‘á»§ Ä‘iá»ƒm báº¯t Ä‘áº§u vÃ  káº¿t thÃºc!");
        return;
      }

      const startCoords = await getCoordinates(start);
      const endCoords = await getCoordinates(end);

      if (!startCoords || !endCoords) {
        alert("KhÃ´ng thá»ƒ láº¥y tá»a Ä‘á»™ cho Ä‘á»‹a chá»‰ nháº­p vÃ o.");
        return;
      }

      // XÃ³a cÃ¡c marker vÃ  tuyáº¿n cÅ©
      routeLayers.forEach(layer => map.removeLayer(layer));
      routeLayers = [];

      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);

      // Ghim Ä‘iá»ƒm báº¯t Ä‘áº§u & káº¿t thÃºc
      startMarker = L.marker(startCoords).addTo(map).bindPopup("ğŸ“ Äiá»ƒm báº¯t Ä‘áº§u").openPopup();
      endMarker = L.marker(endCoords).addTo(map).bindPopup("ğŸ¯ Äiá»ƒm káº¿t thÃºc");

      // Chá»n profile phÃ¹ há»£p vá»›i phÆ°Æ¡ng tiá»‡n
      // GraphHopper API: car, foot, bike (khÃ´ng cÃ³ motorcycle riÃªng, dÃ¹ng bike lÃ m tÆ°Æ¡ng Ä‘Æ°Æ¡ng)
      let profile = mode;
      if (mode === "motorcycle") profile = "bike"; // DÃ¹ng bike thay cho motorcycle

      // Gá»i GraphHopper vá»›i alternative routes - Ä‘iá»u chá»‰nh tham sá»‘ Ä‘á»ƒ cÃ³ nhiá»u lá»™ trÃ¬nh hÆ¡n
      const url = `https://graphhopper.com/api/1/route?point=${startCoords[0]},${startCoords[1]}&point=${endCoords[0]},${endCoords[1]}&vehicle=${profile}&locale=vi&points_encoded=false&algorithm=alternative_route&alternative_route.max_paths=3&alternative_route.max_weight_factor=1.8&alternative_route.max_share_factor=0.8&key=${apiKey}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.paths || data.paths.length === 0) {
          alert("KhÃ´ng tÃ¬m tháº¥y tuyáº¿n Ä‘Æ°á»ng há»£p lá»‡!");
          return;
        }

        const modeText = mode === "car" ? "ğŸš— Xe hÆ¡i" : mode === "motorcycle" ? "ğŸï¸ Xe mÃ¡y" : "ğŸš¶ Äi bá»™";
        let infoHtml = `<b>PhÆ°Æ¡ng tiá»‡n: ${modeText}</b><br><br>`;

        // Sáº¯p xáº¿p theo thá»i gian vÃ  chá»‰ láº¥y 3 tuyáº¿n nhanh nháº¥t
        const sortedPaths = data.paths.slice().sort((a, b) => a.time - b.time).slice(0, 3);

        sortedPaths.forEach((path, idx) => {
          const coords = path.points.coordinates;
          const color = idx === 0 ? "#0078FF" : "#9C27B0";
          const weight = idx === 0 ? 6 : 4;
          const dashArray = idx === 0 ? "" : "10,8";
          
          const timeMin = (path.time / 60000).toFixed(0);
          const distKm = (path.distance / 1000).toFixed(1);

          const layer = L.geoJSON({
            type: "LineString",
            coordinates: coords
          }, {
            style: { color, weight, dashArray, opacity: idx === 0 ? 0.9 : 0.7 }
          }).addTo(map);

          routeLayers.push(layer);

          if (idx === 0) {
            infoHtml += `<div class="route-info">ğŸŸ¦ <b>Tuyáº¿n Ä‘Æ°á»ng tá»‘i Æ°u:</b> ${distKm} km - â±ï¸ <b>${timeMin} phÃºt</b></div>`;
          } else {
            infoHtml += `<div class="route-info">â¬œ Tuyáº¿n phá»¥ ${idx}: ${distKm} km - â±ï¸ ${timeMin} phÃºt</div>`;
          }
        });

        document.getElementById("info").innerHTML = infoHtml;
        map.fitBounds(routeLayers[0].getBounds(), { padding: [50, 50] });

      } catch (err) {
        console.error(err);
        alert("Lá»—i khi láº¥y dá»¯ liá»‡u tá»« GraphHopper!");
      }
    }
  </script>
</body>
</html>
