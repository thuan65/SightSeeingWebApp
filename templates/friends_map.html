<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Real-Time Location Sharing Test - GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        #map { height: 600px; width: 80%; margin: 20px auto; }
    </style>
</head>
<body>

    <h1 style="text-align: center;">Vị trí của User: <span id="username_display">Loading...</span></h1>
    <div id="map"></div>
    <div style="text-align: center;">
        <p>Trạng thái Socket: <strong id="socket_status" style="color: red;">Disconnected</strong></p>
        <p>GPS Status: <strong id="gps_status" style="color: orange;">Đang tìm vị trí...</strong></p>
        <p>Cập nhật vị trí thật mỗi: <strong>5 giây</strong></p>
    </div>
    <hr>
    <div style="text-align: center; margin-top: 10px;">
        <h2>Chia sẻ Vị trí</h2>
        <label for="shareToggle">Trạng thái:</label>
        <button id="shareToggle" data-mode="friends" style="padding: 10px; font-weight: bold;">
            Đang Chia Sẻ (Friends)
        </button>
        <p id="toggleStatus" style="color: grey; margin-top: 5px;">Chế độ hiện tại: <span id="currentMode">Đang Tải...</span></p>
    </div>
    <hr>

    <!-- <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // --- Cấu hình Ban đầu ---
        let user_id = null; 
        let username = 'Unknown';
        let locationInterval = null;
        const socket = io.connect('http://' + document.domain + ':' + location.port);
        const map = L.map('map').setView([10.7769, 106.7009], 13); // Tọa độ mặc định: Sài Gòn
        const markers = {}; // Lưu trữ các marker theo user_id

        // Icon tùy chỉnh (Sử dụng đường dẫn tĩnh từ file list của bạn)
        const selfIcon = L.icon({
            iconUrl: '/static/user-icon.png', // Dùng user-icon.png
            iconSize: [32, 32],
            iconAnchor: [16, 32],
            popupAnchor: [0, -32]
        });

        const friendIcon = L.icon({
            iconUrl: '/static/friend-icon.png', // Dùng friend-icon.png
            iconSize: [64, 64], 
            iconAnchor: [12, 24],
            popupAnchor: [0, -24]
        });

        // Thêm layer bản đồ (OpenStreetMap)
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);

        // --- Hàm Lấy và Cập nhật Vị trí Thật (Geolocation) ---
        function getAndSendLocation() {
            if (user_id === null) return;
            
            document.getElementById('gps_status').innerText = 'Đang tìm vị trí...';
            document.getElementById('gps_status').style.color = 'orange';

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        // HÀM THÀNH CÔNG
                        const lat = position.coords.latitude;
                        const lng = position.coords.longitude;
                        const latlng = [lat, lng];

                        document.getElementById('gps_status').innerText = 'OK';
                        document.getElementById('gps_status').style.color = 'green';
                        
                        // 1. Gửi vị trí thật qua SocketIO
                        socket.emit('update_location', { 
                            lat: lat, 
                            lng: lng 
                        });

                        // 2. Cập nhật marker của chính mình trên map
                        updateMarker(user_id, username, lat, lng, true);
                    },
                    function(error) {
                        // HÀM THẤT BẠI - BÁO LỖI RÕ RÀNG
                        let errorMessage = '';

                        switch (error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = "LỖI: Người dùng từ chối cấp quyền (PERMISSION_DENIED)";
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = "LỖI: Vị trí không xác định được (POSITION_UNAVAILABLE)";
                                break;
                            case error.TIMEOUT:
                                errorMessage = "LỖI: Hết thời gian chờ (TIMEOUT)";
                                break;
                            default:
                                errorMessage = "LỖI: Không xác định (" + error.code + ")";
                                break;
                        }
                        
                        document.getElementById('gps_status').innerText = errorMessage;
                        document.getElementById('gps_status').style.color = 'red';
                        console.error("Geolocation error code:", error.code, error.message);
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000, // Tăng thời gian chờ của API lên 10 giây
                        maximumAge: 0
                    }
                );
            } else {
                document.getElementById('gps_status').innerText = 'Trình duyệt không hỗ trợ Geolocation.';
                document.getElementById('gps_status').style.color = 'red';
            }
        }


        // --- Hàm xử lý cập nhật Marker trên Map ---
        function updateMarker(id, user_name, lat, lng, is_self = false) {
            const latlng = [lat, lng];
            
            if (id in markers) {
                // Di chuyển marker hiện có
                markers[id].marker.setLatLng(latlng);
                markers[id].marker.getPopup().setContent(`<b>${user_name}</b><br>${is_self ? 'Vị trí của bạn' : 'Bạn bè'}`);
            } else {
                // Tạo marker mới
                const marker = L.marker(latlng, {
                    icon: is_self ? selfIcon : friendIcon
                }).addTo(map);

                marker.bindPopup(`<b>${user_name}</b><br>${is_self ? 'Vị trí của bạn' : 'Bạn bè'}`);
                
                markers[id] = {
                    marker: marker,
                    username: user_name
                };
            }
            if (is_self) {
                map.setView(latlng, map.getZoom() > 13 ? map.getZoom() : 13); // Tập trung và zoom tối thiểu 13
            }
            // Chỉ cập nhật username hiển thị ở đây nếu là chính mình
            if (is_self && document.getElementById('username_display').innerText.indexOf('Loading') !== -1) {
                document.getElementById('username_display').innerText = user_name + " (ID: " + id + ")";
            }
        }
        
        // --- Xử lý sự kiện SocketIO ---
        socket.on('connect', function() {
            document.getElementById('socket_status').innerText = 'Connected';
            document.getElementById('socket_status').style.color = 'green';
            console.log('Socket Connected. Fetching user info...');
            
            // 1. Lấy thông tin user (ID và Username)
            fetch('/api/current_user_info')
                .then(res => {
                    if (res.status === 404) {
                        throw new Error("Lỗi 404: /api/current_user_info not found. Cần thêm route vào app.py.");
                    }
                    if (!res.ok) { // Bất kỳ lỗi HTTP nào khác (ví dụ: 401)
                        throw new Error(`Lỗi HTTP ${res.status}. Bạn cần phải đăng nhập.`);
                    }
                    return res.json();
                })
                .then(data => {
                    user_id = data.user_id;
                    username = data.username;
                    document.getElementById('username_display').innerText = username + " (ID: " + user_id + ")";
                    
                    // 2. Bắt đầu cập nhật vị trí thật mỗi 5 giây
                    if (locationInterval) clearInterval(locationInterval);
                    getAndSendLocation(); // Gửi vị trí lần đầu
                    locationInterval = setInterval(getAndSendLocation, 5000); // Gửi định kỳ
                })
                .catch(err => {
                    console.error("Authentication or Info Fetch Error:", err);
                    document.getElementById('username_display').innerText = 'LỖI XÁC THỰC: ' + err.message;
                    document.getElementById('socket_status').innerText = 'Lỗi Auth';
                });
        });

        socket.on('disconnect', function() {
            document.getElementById('socket_status').innerText = 'Disconnected';
            document.getElementById('socket_status').style.color = 'red';
            console.log('Socket Disconnected. Stopping location updates.');
            map.removeLayer(markers[user_id].marker); // Xóa marker của chính mình khi ngắt kết nối
            if (locationInterval) clearInterval(locationInterval);
        });

        // Nhận cập nhật vị trí từ bạn bè
        socket.on('friend_location_update', function(data) {
            console.log(`Location update from ${data.username} (ID: ${data.user_id})`);
            // Kiểm tra: nếu ID người gửi KHÔNG phải là ID của mình
            if (data.user_id !== user_id) { 
                updateMarker(data.user_id, data.username, data.lat, data.lng, false);
            }
        });
        
        // Nhận thông báo trạng thái online/offline từ bạn bè
        socket.on('friend_status_update', function(data) {
            console.log(`Status update: User ${data.user_id} is_online: ${data.is_online}`);
            if (data.user_id in markers) {
                // Làm mờ hoặc hiển thị tùy thuộc vào trạng thái
                markers[data.user_id].marker.setOpacity(data.is_online ? 1.0 : 0.5); 
            }
        });

        socket.on("friend:disconnected", data => {
            const disconnectedUserId = data.userId;

            // Kiểm tra xem marker có tồn tại trong đối tượng markers không
            if (markers[disconnectedUserId]) {
                // 1. Xóa marker khỏi bản đồ
                map.removeLayer(markers[disconnectedUserId]);
                
                // 2. Xóa tham chiếu khỏi đối tượng markers
                delete markers[disconnectedUserId];
                
                console.log(`[CLIENT] Đã xóa marker của User ID: ${disconnectedUserId} (ngắt kết nối)`);
            }
        });

        // Lấy danh sách bạn bè ban đầu (từ HTTP route)
        fetch('/location_sharing/friends_list')
            .then(res => res.json())
            .then(data => {
                console.log('Friend IDs for initialization:', data.friends_ids);
            });

    </script> -->
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
<script>
    // --- Cấu hình Ban đầu ---
    let user_id = null; 
    let username = 'Unknown';
    let locationInterval = null;
    let currentShareMode = 'hidden'; // 'friends' hoặc 'hidden'
    const socket = io.connect('http://' + document.domain + ':' + location.port);
    const map = L.map('map', { 
            // Thêm dòng này để tắt control ghi nhận của Leaflet
            attributionControl: false 
        }).setView([10.7769, 106.7009], 13);
    const markers = {};

    // Sử dụng đường dẫn tĩnh (Đã sửa theo gợi ý trước)
    const ICON_BASE_URL = '/static/locationshare_img/'; // Đảm bảo đường dẫn này đúng
    const selfIcon = L.icon({
        iconUrl: ICON_BASE_URL + 'user-icon.png', 
        iconSize: [40, 40],
        iconAnchor: [16, 32],
        popupAnchor: [0, -32]
    });

    const friendIcon = L.icon({
        iconUrl: ICON_BASE_URL + 'friend-icon.png', 
        iconSize: [50, 50], 
        iconAnchor: [12, 24],
        popupAnchor: [0, -24]
    });

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: ''
    }).addTo(map);

    // --- DOM Elements ---
    const shareToggleButton = document.getElementById('shareToggle');
    const currentModeSpan = document.getElementById('currentMode');

    // --- Hàm Gửi Vị trí Thật (Geolocation) ---
    function getAndSendLocation() {
        if (user_id === null || currentShareMode === 'hidden') return;
        
        document.getElementById('gps_status').innerText = 'Đang tìm vị trí...';
        document.getElementById('gps_status').style.color = 'orange';

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    document.getElementById('gps_status').innerText = 'OK';
                    document.getElementById('gps_status').style.color = 'green';
                    
                    socket.emit('update_location', { lat: lat, lng: lng });

                    updateMarker(user_id, username, lat, lng, true);
                },
                function(error) {
                    let errorMessage = (error.code === 1) ? "LỖI: Từ chối cấp quyền GPS." : "LỖI GPS: Timeout/Không xác định.";
                    document.getElementById('gps_status').innerText = errorMessage;
                    document.getElementById('gps_status').style.color = 'red';
                },
                { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
            );
        } else {
            document.getElementById('gps_status').innerText = 'Trình duyệt không hỗ trợ Geolocation.';
            document.getElementById('gps_status').style.color = 'red';
        }
    }

    // --- Hàm xử lý cập nhật Marker trên Map ---
    function updateMarker(id, user_name, lat, lng, is_self = false) {
        const latlng = [lat, lng];
        
        // YÊU CẦU 3: Hiển thị tên người dùng
        const displayName = is_self ? "Tôi" : user_name;
        // YÊU CẦU 3: Cập nhật popup để hiển thị vị trí cuối (Last Known)
        const popupText = `<b>${displayName}</b><br>${is_self ? 'Vị trí hiện tại' : 'Vị trí cuối'}`;
        
        if (markers[id]) {
            markers[id].setLatLng(latlng);
            markers[id].getPopup().setContent(popupText);
            // Đặt opacity về 1.0 khi nhận được update (vì người này đang online/share)
            markers[id].setOpacity(1.0); 
        } else {
            const marker = L.marker(latlng, { icon: is_self ? selfIcon : friendIcon }).addTo(map);
            marker.bindPopup(popupText);

            // Lưu ID và tên vào đối tượng marker để sử dụng trong event click
            marker.userId = id; // <--- LƯU ID
            marker.userName = user_name; // <--- LƯU TÊN
            
            markers[id] = marker;

            // Chỉ thêm event listener cho bạn bè (is_self=false)
            if (!is_self) {
                // Thêm event listener để gọi hàm hiển thị posts khi click
                marker.on('click', function(e) {
                    showFriendPostsPopup(e.target.userId, e.target.userName, e.target);
                });
            }
        }
        if (is_self) {
            //map.setView(latlng, map.getZoom() > 13 ? map.getZoom() : 13);
            document.getElementById('username_display').innerText = username + " (Tôi)";
        }
        // Gọi hàm fitBounds sau khi marker đã được vẽ/cập nhật
        // Dùng setTimeout để đảm bảo tất cả các event SocketIO đã kịp thời xử lý
        setTimeout(fitMapToAllMarkers, 100);
    }

    // --- HÀM MỚI: XỬ LÝ POPUP BÀI VIẾT BẠN BÈ ---
    function showFriendPostsPopup(friendId, friendName, marker) {
        // Tạm thời hiển thị trạng thái tải
        const loadingContent = `<b>${friendName}</b><br><hr style="margin: 5px 0;"><p>Đang tải 3 bài viết gần nhất...</p>`;
        marker.getPopup().setContent(loadingContent);
        
        // Mở popup
        marker.openPopup();
        
        // Fetch dữ liệu từ API mới
        fetch(`/posts/${friendId}`)
            .then(res => res.json())
            .then(data => {
                let popupContent = `<b>${friendName}</b><br><hr style="margin: 5px 0; border-top: 1px solid #ccc;">`;
                
                if (data.error) {
                    popupContent += `<p style="color:red; font-size: 0.9em;">Lỗi khi tải bài viết: ${data.error}</p>`;
                } else if (data.message && data.message === "No visible posts found for this user.") {
                    popupContent += `<p style="font-size: 0.9em;">Người dùng này chưa có bài viết công khai hoặc bạn bè nào.</p>`;
                } else {
                    // Định dạng danh sách bài viết
                    data.forEach(post => {
                        // TẠO THẺ IMAGE NẾU CÓ filename
                        const imageHtml = post.image_filename 
                            ? `<img src="/static/post_images/${post.image_filename}" style="max-width: 100%; height: auto; border-radius: 4px; margin-bottom: 5px; border: 1px solid #ddd;">` 
                            : '';
                        popupContent += `
                            <div style="margin-bottom: 10px; border: 1px solid #eee; padding: 8px; border-radius: 4px; background-color: #f9f9f9;">
                                 ${imageHtml} <h4 style="margin: 0; font-size: 1.1em;">
                                    <a href="/forum/post/${post.id}" target="_blank" title="Xem thêm trong Forum" style="color: #007bff; text-decoration: none; font-weight: bold;">
                                        ${post.title}
                                    </a>
                                </h4>
                                <p style="margin: 3px 0; font-size: 0.85em; color: #6c757d; border-bottom: 1px dashed #ddd; padding-bottom: 3px;">
                                    ${post.created_at} | Quyền: <i>${post.privacy}</i>
                                </p>
                                <p style="margin: 0; font-size: 0.9em; max-height: 40px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;">
                                    ${post.content_snippet || 'Không có nội dung.'}
                                </p>
                            </div>
                        `;
                    });
                }
                //postsContentDiv.innerHTML = htmlContent;
                // Cập nhật nội dung popup
                marker.getPopup().setContent(popupContent);
                // Đảm bảo popup vẫn mở sau khi cập nhật nội dung
                if (!marker.getPopup().isOpen()) {
                    marker.openPopup();
                }

            })
            .catch(err => {
                const errorContent = `<b>${friendName}</b><br><p style="color:red; font-size: 0.9em;">Lỗi kết nối: Không thể tải bài viết.</p>`;
                marker.getPopup().setContent(errorContent);
                console.error("Lỗi khi fetch post:", err);
            });
    }


    // --- Hàm điều chỉnh view map để bao trùm tất cả markers ---
    function fitMapToAllMarkers() {
        const latLngs = [];
        let needsAdjustment = false;
        
        // 1. Thu thập tất cả tọa độ từ đối tượng markers
        for (const id in markers) {
            if (markers.hasOwnProperty(id)) {
                const marker = markers[id];
                latLngs.push(marker.getLatLng());
                needsAdjustment = true;
            }
        }

        if (needsAdjustment && latLngs.length > 0) {
            try {
                // 2. Tạo đối tượng Bounding Box từ các tọa độ
                const bounds = L.latLngBounds(latLngs);
                
                // 3. Áp dụng fitBounds lên map
                // Padding: thêm một chút khoảng trống (ví dụ: 50 pixels) xung quanh các markers
                map.fitBounds(bounds, { padding: [50, 50], maxZoom: 16 });
                console.log("[CLIENT] Map view đã được điều chỉnh để bao trùm tất cả markers.");

            } catch (error) {
                // Bắt lỗi nếu chỉ có một điểm (Leaflet đôi khi lỗi với chỉ một điểm)
                if (latLngs.length === 1) {
                     map.setView(latLngs[0], 13); // Nếu chỉ có 1 điểm, chỉ cần setView
                } else {
                    console.error("Lỗi khi điều chỉnh fitBounds:", error);
                }
            }
        }
    }



    // --- Quản lý Consent và Toggle ---
    
    function setShareMode(mode) {
        currentShareMode = mode;
        const btnText = (mode === 'friends') ? "Đang Chia Sẻ (Friends)" : "Đã Ẩn (Hidden)";
        shareToggleButton.innerText = btnText;
        shareToggleButton.style.backgroundColor = (mode === 'friends') ? '#4CAF50' : '#f44336';
        currentModeSpan.innerText = mode === 'friends' ? 'Friends' : 'Hidden';
        shareToggleButton.setAttribute('data-mode', mode);

        if (mode === 'friends') {
            // Bắt đầu gửi vị trí
            if (locationInterval) clearInterval(locationInterval);
            getAndSendLocation(); 
            locationInterval = setInterval(getAndSendLocation, 5000);
        } else {
            // Dừng gửi vị trí
            if (locationInterval) clearInterval(locationInterval);
        }

        // Gửi trạng thái mới lên server qua API
        fetch('/api/share_mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: mode })
        })
        .then(res => res.json())
        .then(data => console.log("Trạng thái chia sẻ đã cập nhật:", data))
        .catch(err => console.error("Lỗi khi cập nhật Share Mode:", err));
    }
    
    shareToggleButton.addEventListener('click', () => {
        const oldMode = shareToggleButton.getAttribute('data-mode');
        const newMode = (oldMode === 'friends') ? 'hidden' : 'friends';
        
        if (newMode === 'friends') {
            // YÊU CẦU 1: Hỏi lại khi chuyển từ Hidden sang Friends
            if (oldMode === 'hidden' && !confirm("Bạn có chắc chắn muốn chia sẻ vị trí của mình với bạn bè không?")) {
                 return; // Không làm gì nếu người dùng hủy
            }
            setShareMode('friends');
        } else if (newMode === 'hidden') {
            setShareMode('hidden');
        }
    });

    // --- Xử lý sự kiện SocketIO ---
    socket.on('connect', function() {
        document.getElementById('socket_status').innerText = 'Connected';
        document.getElementById('socket_status').style.color = 'green';
        
        // 1. Lấy thông tin user và share_mode hiện tại
        fetch('/api/current_user_info')
            .then(res => res.json())
            .then(data => {
                user_id = data.user_id;
                username = data.username;
                currentShareMode = data.share_mode || 'friends'; 
                
                // Khởi tạo UI và logic dựa trên share_mode
                // YÊU CẦU 1: Hỏi consent lần đầu nếu share_mode chưa được set
                if (currentShareMode !== 'hidden' && !localStorage.getItem('locationConsentShown')) {
                    if (confirm("Bạn có muốn chia sẻ vị trí của mình với bạn bè không?")) {
                        currentShareMode = 'friends';
                    } else {
                        currentShareMode = 'hidden';
                    }
                    localStorage.setItem('locationConsentShown', 'true');
                }

                setShareMode(currentShareMode); // Cập nhật trạng thái lần đầu


                
                // 2. Lấy vị trí ban đầu của tất cả bạn bè (Lọc bằng share_mode)
                // fetch('/api/friends_list') 
                //     .then(res => res.json())
                //     .then(friendData => {
                //         // Logic phức tạp hơn cần thêm API để lấy LiveLocation/last_known_location 
                //         // của tất cả bạn bè đang ở mode 'friends' hoặc 'online=0'
                //         // VÌ TA KHÔNG CÓ API ĐÓ, TA CHỈ CÓ THỂ CHỜ SOCKETIO CẬP NHẬT.
                //         console.log('Chờ vị trí ban đầu từ SocketIO...');
                //     });
                fetch('/api/initial_locations') 
                    .then(res => res.json())
                    .then(data => {
                        // Vẽ tất cả các vị trí cuối đã được tải
                        data.locations.forEach(loc => {
                            updateMarker(loc.user_id, loc.username, loc.lat, loc.lng, loc.is_self || false);
                        });
                        
                        // Quan trọng: Gọi fitBounds sau khi tất cả markers đã được thêm lần đầu
                        setTimeout(fitMapToAllMarkers, 500); 
                    })
                    .catch(err => console.error("Lỗi khi tải vị trí cuối:", err));
            })
            .catch(err => {
                console.error("Lỗi xác thực hoặc tải thông tin user:", err);
                document.getElementById('username_display').innerText = 'LỖI TẢI USER';
            });
    });

    socket.on('disconnect', function() {
        document.getElementById('socket_status').innerText = 'Disconnected';
        document.getElementById('socket_status').style.color = 'red';
        if (locationInterval) clearInterval(locationInterval);
    });

    // Nhận cập nhật vị trí từ bạn bè
    socket.on('friend_location_update', function(data) {
        if (data.user_id !== user_id) { 
            // Vị trí này là live (người kia đang share_mode='friends')
            updateMarker(data.user_id, data.username, data.lat, data.lng, false);
            // Có thể thêm logic làm sáng marker nếu cần.
        }
    });

    // YÊU CẦU 2: LOẠI BỎ logic xóa marker hoàn toàn. Marker sẽ tồn tại mãi mãi 
    // trừ khi người dùng load lại trang (và không có API lấy vị trí ban đầu)
    // hoặc có một sự kiện xóa rõ ràng từ server (đã loại bỏ).

</script>
</body>
</html>