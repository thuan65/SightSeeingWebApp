<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>B·∫£n ƒë·ªì ch·ªâ ƒë∆∞·ªùng th√¥ng minh</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      padding: 0;
    }
    #map {
      height: 100vh;
      width: 100%;
    }

    .input-container {
      position: absolute;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 10px;
      z-index: 1000;
      background: white;
      border-radius: 50px;
      padding: 10px 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      align-items: center;
    }

    input, select {
      padding: 8px 15px;
      border: 2px solid #7a5af8;
      border-radius: 50px;
      outline: none;
      font-size: 14px;
    }

    button {
      padding: 8px 18px;
      border: none;
      border-radius: 50px;
      background: linear-gradient(90deg,#7a5af8,#9b79ff);
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }

    button:hover {
      opacity: 0.9;
      transform: scale(1.05);
    }

    #info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(255,255,255,0.95);
      border-radius: 12px;
      padding: 18px 28px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      font-size: 16px;
      z-index: 1000;
      min-width: 350px;
      text-align: center;
    }

    #info b {
      font-size: 17px;
      color: #7a5af8;
    }

    .route-info {
      margin: 8px 0;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
    }

    .route-info:last-child {
      border-bottom: none;
    }

  </style>
</head>
<body>

  <div class="input-container">
    <input id="start" type="text" placeholder="ƒêi·ªÉm b·∫Øt ƒë·∫ßu (VD: TP. H·ªì Ch√≠ Minh)">
    <input id="end" type="text" placeholder="ƒêi·ªÉm k·∫øt th√∫c (VD: H√† N·ªôi)">
    
    <select id="mode">
      <option value="car">üöó Xe h∆°i</option>
      <option value="motorcycle">üèçÔ∏è Xe m√°y</option>
      <option value="foot">üö∂ ƒêi b·ªô</option>
    </select>

    <button onclick="findRoute()">Ch·ªâ ƒë∆∞·ªùng</button>
  </div>

  <div id="map"></div>
  <div id="info"></div>

  <script>
    // Kh·ªüi t·∫°o b·∫£n ƒë·ªì
    const map = L.map('map').setView([10.762622, 106.660172], 13);

    // Th√™m n·ªÅn b·∫£n ƒë·ªì
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let routeLayers = [];
    let startMarker, endMarker;

    // H√†m l·∫•y t·ªça ƒë·ªô t·ª´ ƒë·ªãa ch·ªâ
    async function getCoordinates(address) {
      const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(address)}, Vietnam&format=json&limit=1`;
      const res = await fetch(url);
      const data = await res.json();
      if (data.length === 0) return null;
      const { lat, lon, display_name } = data[0];
      if (!display_name.includes("Vietnam") && !display_name.includes("Vi·ªát Nam")) {
        alert(`‚ö†Ô∏è ƒê·ªãa ch·ªâ "${address}" kh√¥ng n·∫±m trong Vi·ªát Nam!`);
        return null;
      }
      return [parseFloat(lat), parseFloat(lon)];
    }

    // H√†m t√¨m ƒë∆∞·ªùng
    async function findRoute() {
      const start = document.getElementById("start").value.trim();
      const end = document.getElementById("end").value.trim();
      const mode = document.getElementById("mode").value;
      const apiKey = "510b2242-84d4-45c2-97fa-baa242e6a4b7";

      if (!start || !end) {
        alert("Vui l√≤ng nh·∫≠p ƒë·ªß ƒëi·ªÉm b·∫Øt ƒë·∫ßu v√† k·∫øt th√∫c!");
        return;
      }

      const startCoords = await getCoordinates(start);
      const endCoords = await getCoordinates(end);

      if (!startCoords || !endCoords) {
        alert("Kh√¥ng th·ªÉ l·∫•y t·ªça ƒë·ªô cho ƒë·ªãa ch·ªâ nh·∫≠p v√†o.");
        return;
      }

      // X√≥a c√°c marker v√† tuy·∫øn c≈©
      routeLayers.forEach(layer => map.removeLayer(layer));
      routeLayers = [];

      if (startMarker) map.removeLayer(startMarker);
      if (endMarker) map.removeLayer(endMarker);

      // Ghim ƒëi·ªÉm b·∫Øt ƒë·∫ßu & k·∫øt th√∫c
      startMarker = L.marker(startCoords).addTo(map).bindPopup("üìç ƒêi·ªÉm b·∫Øt ƒë·∫ßu").openPopup();
      endMarker = L.marker(endCoords).addTo(map).bindPopup("üéØ ƒêi·ªÉm k·∫øt th√∫c");

      // Ch·ªçn profile ph√π h·ª£p v·ªõi ph∆∞∆°ng ti·ªán
      let profile = mode;
      if (mode === "motorcycle") profile = "motorcycle"; // GraphHopper h·ªó tr·ª£ motorcycle

      // G·ªçi GraphHopper v·ªõi algorithm=alternative_route ƒë·ªÉ c√≥ nhi·ªÅu l·ªô tr√¨nh
      const url = `https://graphhopper.com/api/1/route?point=${startCoords[0]},${startCoords[1]}&point=${endCoords[0]},${endCoords[1]}&vehicle=${profile}&locale=vi&points_encoded=false&algorithm=alternative_route&alternative_route.max_paths=3&key=${apiKey}`;

      try {
        const res = await fetch(url);
        const data = await res.json();

        if (!data.paths || data.paths.length === 0) {
          alert("Kh√¥ng t√¨m th·∫•y tuy·∫øn ƒë∆∞·ªùng h·ª£p l·ªá!");
          return;
        }

        const modeText = mode === "car" ? "üöó Xe h∆°i" : mode === "motorcycle" ? "üèçÔ∏è Xe m√°y" : "üö∂ ƒêi b·ªô";
        let infoHtml = `<b>Ph∆∞∆°ng ti·ªán: ${modeText}</b><br><br>`;

        data.paths.forEach((path, idx) => {
          const coords = path.points.coordinates;
          const color = idx === 0 ? "#0066ff" : "#6b6a6a";
          const weight = idx === 0 ? 6 : 5;
          const dashArray = idx === 0 ? "" : "8,6";
          
          const timeMin = (path.time / 60000).toFixed(0);
          const distKm = (path.distance / 1000).toFixed(1);

          const layer = L.geoJSON({
            type: "LineString",
            coordinates: coords
          }, {
            style: { color, weight, dashArray, opacity: idx === 0 ? 0.9 : 0.6 }
          }).addTo(map);

          routeLayers.push(layer);

          const routeLabel = idx === 0 ? "üü¶ Tuy·∫øn ƒë∆∞·ªùng t·ªëi ∆∞u" : `‚¨ú Tuy·∫øn ph·ª• ${idx}`;
          infoHtml += `<div class="route-info">${routeLabel}: <b>${distKm} km</b> - ‚è±Ô∏è <b>${timeMin} ph√∫t</b></div>`;
        });

        document.getElementById("info").innerHTML = infoHtml;
        map.fitBounds(routeLayers[0].getBounds(), { padding: [50, 50] });

      } catch (err) {
        console.error(err);
        alert("L·ªói khi l·∫•y d·ªØ li·ªáu t·ª´ GraphHopper!");
      }
    }
  </script>
</body>
</html>