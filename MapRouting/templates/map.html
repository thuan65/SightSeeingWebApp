<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sonna Guide</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=VT323&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        /* --- RETRO THEME VARIABLES --- */
        :root {
            --bg-color: #99a48b;
            --panel-bg: #aeb9a2;
            --text-color: #1a1a1a;
            --border-width: 4px;
            --shadow-offset: 6px;
            --input-bg: #8c977d;
            --highlight: #f0f4e8;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'VT323', monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            font-size: 20px;
            background-image:
                linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px);
            background-size: 20px 20px;
            /* Layout Flex cho Sidebar + Main */
            display: flex;
            overflow: hidden;
        }

        /* --- SIDEBAR (Favorite) --- */
        #sidebar {
            width: 320px;
            background: var(--panel-bg);
            border-right: var(--border-width) solid var(--text-color);
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 2000;
            box-shadow: 4px 0 10px rgba(0,0,0,0.2);
        }

        #sidebar h2 {
            font-family: 'Press Start 2P', cursive;
            font-size: 1.2em;
            margin-bottom: 20px;
            text-align: center;
            border-bottom: 4px solid var(--text-color);
            padding-bottom: 15px;
            line-height: 1.5;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }

        /* --- C·∫¨P NH·∫¨T FONT CHO SIDEBAR (D·ªÑ ƒê·ªåC H∆†N) --- */

        .fav-item {
            /* ƒê·ªïi sang font kh√¥ng ch√¢n, h·ªó tr·ª£ ti·∫øng Vi·ªát t·ªët */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 16px; /* Gi·∫£m size xu·ªëng 1 ch√∫t cho g·ªçn (VT323 th∆∞·ªùng ph·∫£i ƒë·ªÉ to) */
            line-height: 1.5;

            /* C√°c thu·ªôc t√≠nh c≈© gi·ªØ nguy√™n ƒë·ªÉ gi·ªØ style th·∫ª b√†i */
            background: var(--input-bg);
            border: 3px solid var(--text-color);
            margin-bottom: 15px;
            padding: 15px;
            cursor: pointer;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.2);
            transition: transform 0.1s;
            position: relative;
        }

        .fav-item:hover {
            transform: translate(-2px, -2px);
            box-shadow: 6px 6px 0 rgba(0,0,0,0.3);
            background: var(--highlight);
        }

        .fav-item:active {
            transform: translate(2px, 2px);
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        .fav-icon {
            float: left;
            margin-right: 12px;
            font-size: 1.5em;
            margin-top: 2px;
        }

        .fav-item h3 {
            /* B·ªè font 'Press Start 2P' ·ªü ƒë√¢y ƒë·ªÉ t√™n ƒë·ªãa ƒëi·ªÉm d·ªÖ ƒë·ªçc h∆°n */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-weight: 800; /* In ƒë·∫≠m ƒë·∫≠m ƒë√† */
            font-size: 1.1em;
            text-transform: uppercase;
            margin-bottom: 5px;
            line-height: 1.3;
            color: #000;
        }

        .fav-tag {
            display: inline-block;
            background: var(--text-color);
            color: var(--bg-color);
            padding: 3px 8px;
            font-size: 0.75em;
            margin-top: 8px;
            font-weight: bold;
            border-radius: 4px; /* Bo g√≥c nh·∫π cho m·ªÅm m·∫°i h∆°n */
            font-family: 'VT323', monospace; /* Gi·ªØ tag l√† font retro cho phong c√°ch */
        }

        /* --- MAIN CONTENT --- */
        #main-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* --- HEADER --- */
        .header { text-align: center; padding: 30px 20px; text-transform: uppercase; flex-shrink: 0; }
        .header h1 {
            font-family: 'Press Start 2P', cursive;
            font-size: 2em; margin-bottom: 10px;
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
            line-height: 1.5;
        }
        .header p {
            font-size: 1.2em; letter-spacing: 1px;
            border-bottom: 4px solid var(--text-color);
            display: inline-block; padding-bottom: 5px;
        }

        .container { max-width: 1000px; margin: 0 auto; padding: 0 20px 40px; width: 100%; }

        /* --- PANELS --- */
        .control-panel, .result-panel {
            background: var(--panel-bg);
            border: var(--border-width) solid var(--text-color);
            padding: 25px; margin-bottom: 30px;
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px var(--text-color);
        }

        /* --- SELECTORS --- */
        .selector-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 25px; }
        .selector-box { border: var(--border-width) solid var(--text-color); background: var(--bg-color); }
        .selector-header {
            background: var(--text-color); color: var(--bg-color); padding: 15px;
            cursor: pointer; display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 1.1em; text-transform: uppercase;
        }
        .selector-header:hover { background: #333; }
        .status-text { margin-left: 10px; opacity: 0.6; font-family: 'VT323', monospace; font-weight: normal; }
        .selector-content { max-height: 0; overflow: hidden; border-top: 0; }
        .selector-box.expanded .selector-content { max-height: 400px; border-top: var(--border-width) solid var(--text-color); }
        .selector-options { padding: 15px; display: grid; gap: 15px; }

        /* --- BUTTONS --- */
        .option-btn, .use-location-btn, .geocode-btn, .add-dest-btn, .calculate-btn {
            border: var(--border-width) solid var(--text-color); background: var(--panel-bg);
            cursor: pointer; font-family: 'VT323', monospace; text-transform: uppercase; font-weight: bold;
            box-shadow: 4px 4px 0px rgba(0,0,0,0.2); transition: transform 0.1s; padding: 15px;
            font-size: 1.1em; display: flex; align-items: center; gap: 15px;
        }
        .option-btn:hover, .use-location-btn:hover, .add-dest-btn:hover, .calculate-btn:hover {
            background: #cdd6c3; transform: translate(-2px, -2px); box-shadow: 6px 6px 0px rgba(0,0,0,0.2);
        }
        .option-btn:active, .use-location-btn:active, .add-dest-btn:active, .calculate-btn:active {
            transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0,0,0,0.2);
        }
        .option-btn.active { background: var(--text-color); color: var(--bg-color); box-shadow: none; transform: translate(2px, 2px); }
        .retro-icon { font-family: monospace; font-weight: bold; letter-spacing: -1px; }

        /* --- INPUTS --- */
        .input-group label { display: block; margin-bottom: 10px; font-weight: bold; font-size: 1.3em; text-transform: uppercase; }
        input[type="text"] {
            width: 100%; padding: 15px; border: var(--border-width) solid var(--text-color);
            background: var(--input-bg); font-family: 'VT323', monospace; font-size: 1.3em; color: var(--text-color);
            box-shadow: inset 4px 4px 0px rgba(0,0,0,0.1);
        }
        input[type="text"]:focus { outline: none; background: #f0f4e8; }
        .input-container { position: relative; }
        .geocode-btn {
            position: absolute; right: 8px; top: 50%; transform: translateY(-50%);
            padding: 5px 15px; font-size: 1.2em; box-shadow: none; border-width: 3px;
        }
        .calculate-btn { width: 100%; padding: 20px; font-size: 1.8em; background: var(--text-color); color: white; margin-top: 20px; justify-content: center; box-shadow: 8px 8px 0px rgba(0,0,0,0.3); }
        .calculate-btn:hover { background: #333; color: #fff; }
        .add-dest-btn { width: 100%; padding: 15px; margin-bottom: 15px; background: #4a6d4c; color: white; justify-content: center; }
        .use-location-btn { margin-top: 10px; padding: 10px 20px; font-size: 1em; background: #5c7c8a; color: white; }

        /* --- MAP & RESULTS --- */
        #map {
            height: 500px; border: var(--border-width) solid var(--text-color);
            box-shadow: var(--shadow-offset) var(--shadow-offset) 0px var(--text-color);
            filter: sepia(0.4) contrast(1.1) grayscale(0.2);
        }
        .result-panel { display: none; }
        .result-panel.show { display: block; }
        .result-panel h3 {
            font-family: 'Press Start 2P', cursive; margin-bottom: 20px; font-size: 1.5em;
            border-bottom: 4px solid var(--text-color); padding-bottom: 10px;
        }
        .result-info { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .info-card {
            background: var(--input-bg); border: 3px solid var(--text-color);
            padding: 15px; box-shadow: 4px 4px 0px rgba(0,0,0,0.1);
        }
        .info-card .label { font-size: 1em; text-transform: uppercase; font-weight: bold; color: #333; }
        .info-card .value { font-family: 'Press Start 2P', cursive; font-size: 1.2em; color: var(--text-color); margin-top: 10px; }

        .destination-item {
            background: var(--bg-color); padding: 20px; border: 3px solid var(--text-color);
            margin-bottom: 15px; position: relative; border-left: 10px solid var(--text-color);
        }
        .quest-label { display: flex; align-items: center; margin-bottom: 10px; font-weight: bold; font-size: 1.3em; text-transform: uppercase; }
        .color-block { display: inline-block; width: 24px; height: 24px; border: 3px solid var(--text-color); margin-right: 15px; box-shadow: 3px 3px 0px rgba(0,0,0,0.2); }
        .remove-dest {
            position: absolute; top: 12px; right: 12px; background: #d95763; color: white;
            border: 3px solid black; width: 40px; height: 40px; font-family: 'Press Start 2P';
            cursor: pointer; box-shadow: 4px 4px 0px black; font-size: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .remove-dest:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px black; }

        .coord-display { font-family: monospace; background: var(--text-color); color: #0f0; padding: 10px; margin-top: 10px; display: none; }
        .coord-display.show { display: block; }

        .loading, .error-message { display: none; text-align: center; padding: 20px; }
        .loading.show { display: block; }
        .spinner {
            border: 6px solid var(--input-bg); border-top: 6px solid var(--text-color);
            width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .error-message {
            background: #d95763; border: 4px solid black; color: white; font-weight: bold;
            padding: 15px; margin-top: 15px; box-shadow: 6px 6px 0px black;
        }
        .error-message.show { display: block; }

        .input-section { display: none; }
        .input-section.active { display: block; }

        /* --- RPG ICON STYLES --- */
        .rpg-icon-marker {
            background: none; border: none; text-align: center;
            font-size: 35px; line-height: 1; filter: drop-shadow(4px 4px 0px rgba(0,0,0,1));
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 900px) {
            body { flex-direction: column; overflow-y: auto; height: auto; }
            #sidebar { width: 100%; height: 300px; order: 2; border-right: none; border-top: var(--border-width) solid var(--text-color); }
            #main-content { height: auto; order: 1; }
        }
    </style>
</head>
<body>

    <div id="sidebar">
        <h2>Favorite</h2>
        <div id="favorites-list">
            <p style="text-align: center; padding-top: 20px;">[INSERT MEMORY CARD...]</p>
        </div>
    </div>

    <div id="main-content">
        <div class="header">
            <h1>SONNA GUIDE</h1>
            <p>B·∫£n ƒë·ªì Vi·ªát Nam</p>
        </div>

        <div class="container">
            <div class="control-panel">
                <div class="selector-row">
                    <div class="selector-box" id="mode-box">
                        <div class="selector-header" onclick="toggleSelector('mode-box')">
                            <div><span>> CH·∫æ ƒê·ªò</span> <span class="status-text" id="mode-status">:: ƒê∆†N</span></div>
                            <span class="selector-icon">‚ñº</span>
                        </div>
                        <div class="selector-content">
                            <div class="selector-options mode-options">
                                <div class="option-btn active" data-mode="single" onclick="selectMode('single')">
                                    <div class="retro-icon">[1]</div><div>CH·ªà ƒê∆Ø·ªúNG ƒê∆†N</div>
                                </div>
                                <div class="option-btn" data-mode="multi" onclick="selectMode('multi')">
                                    <div class="retro-icon">[1-3]</div><div>ƒêA ƒêI·ªÇM</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="selector-box" id="vehicle-box">
                        <div class="selector-header" onclick="toggleSelector('vehicle-box')">
                            <div><span>> PH∆Ø∆†NG TI·ªÜN</span> <span class="status-text" id="vehicle-status">:: XE H∆†I</span></div>
                            <span class="selector-icon">‚ñº</span>
                        </div>
                        <div class="selector-content">
                            <div class="selector-options vehicle-options">
                                <div class="option-btn active" data-vehicle="car" onclick="selectVehicle('car')">
                                    <div class="retro-icon">[CAR]</div><div>XE H∆†I</div>
                                </div>
                                <div class="option-btn" data-vehicle="bike" onclick="selectVehicle('bike')">
                                    <div class="retro-icon">[BIKE]</div><div>XE ƒê·∫†P</div>
                                </div>
                                <div class="option-btn" data-vehicle="foot" onclick="selectVehicle('foot')">
                                    <div class="retro-icon">[WALK]</div><div>ƒêI B·ªò</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="input-section active" id="single-mode">
                    <div class="input-group">
                        <label>START POINT</label>
                        <div class="input-container">
                            <input type="text" id="start-address" placeholder="NH·∫¨P V·ªä TR√ç..." oninput="resetCoord('start')">
                            <button class="geocode-btn" onclick="geocodeAddress('start')" title="T√¨m t·ªça ƒë·ªô">üîç</button>
                        </div>
                        <div class="coord-display" id="start-coords"></div>
                        <button class="use-location-btn" onclick="useCurrentLocation('start')">D√ôNG GPS C·ª¶A T√îI</button>
                    </div>

                    <div class="input-group">
                        <label>END POINT</label>
                        <div class="input-container">
                            <input type="text" id="end-address" placeholder="NH·∫¨P ƒê√çCH ƒê·∫æN..." oninput="resetCoord('end')">
                            <button class="geocode-btn" onclick="geocodeAddress('end')" title="T√¨m t·ªça ƒë·ªô">üîç</button>
                        </div>
                        <div class="coord-display" id="end-coords"></div>
                    </div>

                    <button class="calculate-btn" onclick="calculateSingleRoute()">START MISSION</button>
                </div>

                <div class="input-section" id="multi-mode">
                    <div class="input-group">
                        <label>BASE (XU·∫§T PH√ÅT)</label>
                        <div class="input-container">
                            <input type="text" id="multi-start-address" placeholder="NH·∫¨P BASE..." oninput="resetCoord('multi-start')">
                            <button class="geocode-btn" onclick="geocodeAddress('multi-start')" title="T√¨m t·ªça ƒë·ªô">üîç</button>
                        </div>
                        <div class="coord-display" id="multi-start-coords"></div>
                        <button class="use-location-btn" onclick="useCurrentLocation('multi-start')">D√ôNG GPS</button>
                    </div>

                    <div class="input-group">
                        <label>QUEST LOG (ƒêI·ªÇM ƒê·∫æN)</label>
                        <div id="destinations-container"></div>
                        <button class="add-dest-btn" onclick="addDestination()" id="add-dest-btn">‚ûï ADD QUEST MARKER</button>
                    </div>

                    <button class="calculate-btn" onclick="calculateMultiRoute()">OPTIMIZE PATH</button>
                </div>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p style="margin-top: 15px; font-weight: bold;">LOADING MAP DATA...</p>
                </div>

                <div class="error-message" id="error-message"></div>
            </div>

            <div class="result-panel" id="result-panel">
                <h3>MISSION REPORT</h3>
                <div class="result-info" id="result-info"></div>
            </div>

            <div id="map"></div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let map;
        let currentMode = 'single';
        let selectedVehicle = 'car';
        let routeLayer = null;
        let markersLayer = null;
        let destinationCount = 0;

        let geocodedCoords = {
            start: null,
            end: null,
            'multi-start': null,
            destinations: {}
        };

        const routeColors = ['#FF6B6B', '#4ECDC4', '#45B7D1', '#FFA07A', '#98D8C8', '#F7B731', '#5F27CD', '#00D2D3'];
        const destinationColors = ['#FF6B6B', '#4ECDC4', '#45B7D1'];

        function resetCoord(prefix) {
            geocodedCoords[prefix] = null;
            document.getElementById(prefix + '-coords').classList.remove('show');
            document.getElementById('error-message').classList.remove('show');
        }

        function resetDestCoord(id) {
            delete geocodedCoords.destinations[id];
            document.getElementById(`dest-${id}-coords`).classList.remove('show');
        }

        function createCustomIcon(type, color, number) {
            let char = '';
            let iconColor = color;
            let badge = '';

            if (type === 'start') {
                char = '‚òñ';
                iconColor = '#4CAF50';
            } else if (type === 'end') {
                char = '‚öë';
                iconColor = '#F44336';
            } else if (type === 'waypoint') {
                char = '‚öë';
                badge = `<span style="position:absolute; bottom:-5px; right:-10px; font-family:'Press Start 2P'; font-size:12px; background:#000; color:#fff; padding:2px 4px; border:2px solid #fff;">${number}</span>`;
            }

            return L.divIcon({
                html: `<div style="color: ${iconColor}; font-weight: bold; position: relative;">${char}${badge}</div>`,
                className: 'rpg-icon-marker',
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            });
        }

        function initMap() {
            map = L.map('map', { 
            // Th√™m d√≤ng n√†y ƒë·ªÉ t·∫Øt control ghi nh·∫≠n c·ªßa Leaflet
            attributionControl: false 
            }).setView([16.0544, 108.2022], 6);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: ''
            }).addTo(map);
            markersLayer = L.layerGroup().addTo(map);
        }

        // --- FAVORITES LOGIC (NEW) ---
        async function loadFavorites() {
            const listDiv = document.getElementById('favorites-list');
            listDiv.innerHTML = '<p style="text-align: center; padding-top: 20px;">READING SAVE DATA...</p>';

            try {
                // G·ªçi API l·∫•y danh s√°ch y√™u th√≠ch
                const res = await fetch(`/MapRouting/api/favorites`);

                // Ki·ªÉm tra l·ªói 401/403 (Ch∆∞a ƒëƒÉng nh·∫≠p)
                if (res.status === 401 || res.status === 403) {
                    listDiv.innerHTML = `
                        <div style="text-align:center; padding: 10px; background: #d95763; color: white; border: 3px solid #000;">
                            ‚ö† LOCKED<br>
                            <small>LOGIN REQUIRED</small><br>
                            <a href="/auth/login" style="color: yellow; font-weight: bold;">[INSERT COIN/LOGIN]</a>
                        </div>`;
                    return;
                }

                // Ki·ªÉm tra n·∫øu response kh√¥ng OK
                if (!res.ok) {
                    // Th·ª≠ parse JSON error message
                    let errorMsg = 'Unknown error';
                    try {
                        const errorData = await res.json();
                        errorMsg = errorData.error || `HTTP ${res.status}`;
                    } catch (e) {
                        errorMsg = `HTTP ${res.status}: ${res.statusText}`;
                    }
                    
                    listDiv.innerHTML = `
                        <div style="text-align:center; padding: 10px; background: #d95763; color: white; border: 3px solid #000;">
                            ‚ö† ERROR<br>
                            <small>${errorMsg}</small>
                        </div>`;
                    console.error("Favorites API Error:", errorMsg);
                    return;
                }

                // Ki·ªÉm tra content-type tr∆∞·ªõc khi parse JSON
                const contentType = res.headers.get("content-type");
                if (!contentType || !contentType.includes("application/json")) {
                    const text = await res.text();
                    console.error("Favorites API returned non-JSON:", text.substring(0, 100));
                    listDiv.innerHTML = `
                        <div style="text-align:center; padding: 10px; background: #d95763; color: white; border: 3px solid #000;">
                            ‚ö† ERROR<br>
                            <small>Invalid response format</small>
                        </div>`;
                    return;
                }

                const data = await res.json();
                listDiv.innerHTML = '';

                // Ki·ªÉm tra n·∫øu API tr·∫£ v·ªÅ success = false
                if (!data.success) {
                    const errorMsg = data.error || 'Unknown error';
                    listDiv.innerHTML = `
                        <div style="text-align:center; padding: 10px; background: #d95763; color: white; border: 3px solid #000;">
                            ‚ö† ERROR<br>
                            <small>${errorMsg}</small>
                        </div>`;
                    console.error("Favorites API returned error:", errorMsg);
                    return;
                }

                // Ki·ªÉm tra n·∫øu c√≥ d·ªØ li·ªáu
                if(data.data && data.data.length > 0) {
                    data.data.forEach(item => {
                        // B·ªè qua items c√≥ l·ªói geocode
                        if (item.error) {
                            console.warn("Skipping favorite with geocode error:", item.name);
                            return;
                        }

                        const div = document.createElement('div');
                        div.className = 'fav-item';

                        let tagDisplay = item.tags ? item.tags.split(',')[0] : 'LOC';
                        let addrDisplay = item.address ? `<div style="font-size:0.7em; margin-bottom:5px; font-style:italic; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; opacity:0.8;">${item.address}</div>` : '';

                        div.innerHTML = `
                            <div class="fav-icon">‚òÖ</div>
                            <h3>${item.name}</h3>
                            ${addrDisplay}
                            <span class="fav-tag">#${tagDisplay}</span>
                        `;
                        div.onclick = () => routeToFavorite(item);
                        listDiv.appendChild(div);
                    });
                    
                    // N·∫øu kh√¥ng c√≥ item n√†o h·ª£p l·ªá sau khi filter
                    if (listDiv.children.length === 0) {
                        listDiv.innerHTML = '<p style="text-align:center; padding-top:20px;">NO VALID LOCATIONS FOUND.</p>';
                    }
                } else {
                    listDiv.innerHTML = '<p style="text-align:center; padding-top:20px;">EMPTY SAVE SLOTS.</p>';
                }
            } catch (e) {
                console.error("Favorite Error:", e);
                const errorMsg = e.message || 'Network error or server unavailable';
                listDiv.innerHTML = `
                    <div style="text-align:center; padding: 10px; background: #d95763; color: white; border: 3px solid #000;">
                        ‚ö† MEMORY CARD ERROR<br>
                        <small>${errorMsg}</small><br>
                        <small style="font-size:0.7em; opacity:0.8;">Check console for details</small>
                    </div>`;
            }
        }

        function routeToFavorite(dest) {
            // Chuy·ªÉn v·ªÅ ch·∫ø ƒë·ªô ƒë∆°n
            selectMode('single');

            // ƒêi·ªÅn th√¥ng tin v√†o √¥ ƒê√≠ch ƒê·∫øn
            document.getElementById('end-address').value = dest.name; // Ho·∫∑c dest.address
            geocodedCoords.end = { lat: dest.lat, lon: dest.lon };

            // Hi·ªÉn th·ªã t·ªça ƒë·ªô ƒë√£ load
            const coordDiv = document.getElementById('end-coords');
            coordDiv.innerHTML = `> LOADED: [${dest.lat.toFixed(4)}, ${dest.lon.toFixed(4)}]`;
            coordDiv.classList.add('show');

            showLoading(true);

            // T·ª± ƒë·ªông l·∫•y v·ªã tr√≠ hi·ªán t·∫°i l√†m ƒëi·ªÉm ƒëi
            if(navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        const lat = pos.coords.latitude;
                        const lon = pos.coords.longitude;
                        document.getElementById('start-address').value = "CURRENT LOCATION";
                        geocodedCoords.start = { lat: lat, lon: lon };
                        const startDiv = document.getElementById('start-coords');
                        startDiv.innerHTML = `> GPS: [${lat.toFixed(4)}, ${lon.toFixed(4)}]`;
                        startDiv.classList.add('show');

                        calculateSingleRoute();
                    },
                    (err) => {
                        showError("GPS FAILED. PLEASE ENTER START POINT.");
                        showLoading(false);
                        document.getElementById('start-address').focus();
                    }
                );
            } else {
                showError("NO GPS DEVICE DETECTED.");
                showLoading(false);
            }
        }

        // --- END FAVORITES LOGIC ---

        function toggleSelector(boxId) {
            const box = document.getElementById(boxId);
            box.classList.toggle('expanded');
        }

        function selectMode(mode) {
            document.querySelectorAll('[data-mode]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-mode="${mode}"]`).classList.add('active');
            currentMode = mode;
            const text = mode === 'single' ? ':: ƒê∆†N' : ':: ƒêA ƒêI·ªÇM';
            document.getElementById('mode-status').textContent = text;
            document.querySelectorAll('.input-section').forEach(s => s.classList.remove('active'));
            document.getElementById(mode + '-mode').classList.add('active');
            toggleSelector('mode-box');
            clearMap();
        }

        function selectVehicle(vehicle) {
            document.querySelectorAll('[data-vehicle]').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`[data-vehicle="${vehicle}"]`).classList.add('active');
            selectedVehicle = vehicle;
            let text = ':: XE H∆†I';
            if(vehicle === 'bike') text = ':: XE ƒê·∫†P';
            if(vehicle === 'foot') text = ':: ƒêI B·ªò';
            document.getElementById('vehicle-status').textContent = text;
            toggleSelector('vehicle-box');
        }

        async function geocodeAddress(prefix) {
            const input = document.getElementById(prefix + '-address');
            const address = input.value.trim();
            if (!address) { showError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ'); return; }
            const btn = input.nextElementSibling;
            btn.disabled = true; btn.textContent = '‚è≥';

            try {
                const response = await fetch('/MapRouting/api/geocode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: address})
                });
                const data = await response.json();

                if (data.success && data.data) {
                    // --- ƒêO·∫†N CODE FIX L·ªñI: Ki·ªÉm tra k·ªπ l∆∞·ª°ng ---
                    // T·ª± ƒë·ªông nh·∫≠n di·ªán 'lon' ho·∫∑c 'lng'
                    const rawLat = data.data.lat;
                    const rawLon = (data.data.lon !== undefined) ? data.data.lon : data.data.lng;

                    // √âp ki·ªÉu sang s·ªë (float) ƒë·ªÉ tr√°nh l·ªói text
                    const lat = parseFloat(rawLat);
                    const lon = parseFloat(rawLon);

                    // N·∫øu kh√¥ng ph·∫£i s·ªë h·ª£p l·ªá th√¨ b√°o l·ªói thay v√¨ crash trang web
                    if (isNaN(lat) || isNaN(lon)) {
                        console.error("D·ªØ li·ªáu t·ªça ƒë·ªô l·ªói:", data.data);
                        showError("L·ªói d·ªØ li·ªáu t·ªça ƒë·ªô t·ª´ Server");
                        return;
                    }

                    geocodedCoords[prefix] = { lat: lat, lon: lon };

                    const coordDiv = document.getElementById(prefix + '-coords');
                    // B√¢y gi·ªù g·ªçi .toFixed(4) ch·∫Øc ch·∫Øn s·∫Ω an to√†n
                    coordDiv.innerHTML = `> LOC: [${lat.toFixed(4)}, ${lon.toFixed(4)}]<br><small>${data.data.display_name}</small>`;
                    coordDiv.classList.add('show');
                    showError('ƒê√£ t√¨m th·∫•y t·ªça ƒë·ªô!', false);
                } else {
                    showError(data.error || "Kh√¥ng t√¨m th·∫•y ƒë·ªãa ƒëi·ªÉm");
                }
            } catch (error) {
                console.error(error);
                showError('L·ªói k·∫øt n·ªëi: ' + error.message);
            }
            finally { btn.disabled = false; btn.textContent = '‚úì'; setTimeout(() => btn.textContent = 'üîç', 2000); }
        }

        async function geocodeDestination(id) {
            const input = document.getElementById(`dest-${id}-address`);
            const address = input.value.trim();
            if (!address) { showError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ'); return; }
            const btn = input.nextElementSibling;
            btn.disabled = true; btn.textContent = '‚è≥';

            try {
                const response = await fetch('/MapRouting/api/geocode', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({address: address})
                });
                const data = await response.json();

                if (data.success && data.data) {
                    // --- ƒêO·∫†N CODE FIX L·ªñI T∆Ø∆†NG T·ª∞ ---
                    const rawLat = data.data.lat;
                    const rawLon = (data.data.lon !== undefined) ? data.data.lon : data.data.lng;
                    const lat = parseFloat(rawLat);
                    const lon = parseFloat(rawLon);

                    if (isNaN(lat) || isNaN(lon)) {
                        showError("L·ªói d·ªØ li·ªáu t·ªça ƒë·ªô"); return;
                    }

                    geocodedCoords.destinations[id] = { lat: lat, lon: lon };
                    const coordDiv = document.getElementById(`dest-${id}-coords`);
                    coordDiv.innerHTML = `> LOC: [${lat.toFixed(4)}, ${lon.toFixed(4)}]<br><small>${data.data.display_name}</small>`;
                    coordDiv.classList.add('show');
                    showError('ƒê√£ t√¨m th·∫•y t·ªça ƒë·ªô!', false);
                } else { showError(data.error); }
            } catch (error) { showError('L·ªói k·∫øt n·ªëi: ' + error.message); }
            finally { btn.disabled = false; btn.textContent = '‚úì'; setTimeout(() => btn.textContent = 'üîç', 2000); }
        }

        function useCurrentLocation(prefix) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function(position) {
                    geocodedCoords[prefix] = { lat: position.coords.latitude, lon: position.coords.longitude };
                    const coordDiv = document.getElementById(prefix + '-coords');
                    coordDiv.innerHTML = `> GPS: [${position.coords.latitude.toFixed(4)}, ${position.coords.longitude.toFixed(4)}]<br><small>V·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</small>`;
                    coordDiv.classList.add('show');
                    document.getElementById(prefix + '-address').value = 'V·ªã tr√≠ hi·ªán t·∫°i';
                    showError('ƒê√£ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i!', false);
                }, function(error) { showError('Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i: ' + error.message); });
            } else { showError('Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ ƒë·ªãnh v·ªã'); }
        }

        function addDestination() {
            if (destinationCount >= 3) { showError('T·ªëi ƒëa 3 ƒëi·ªÉm ƒë·∫øn'); return; }
            destinationCount++;
            const container = document.getElementById('destinations-container');
            const div = document.createElement('div');
            div.className = 'destination-item';
            div.id = 'dest-' + destinationCount;
            const color = destinationColors[(destinationCount - 1) % destinationColors.length];

            div.innerHTML = `
                <button class="remove-dest" onclick="removeDestination(${destinationCount})">√ó</button>
                <div class="quest-label">
                    <span class="color-block" style="background: ${color}"></span>
                    QUEST ${destinationCount}
                </div>
                <div class="input-container">
                    <input type="text" id="dest-${destinationCount}-address" placeholder="NH·∫¨P QUEST ${destinationCount}..." oninput="resetDestCoord(${destinationCount})">
                    <button class="geocode-btn" onclick="geocodeDestination(${destinationCount})" title="T√¨m t·ªça ƒë·ªô">üîç</button>
                </div>
                <div class="coord-display" id="dest-${destinationCount}-coords"></div>
            `;
            container.appendChild(div);
            if (destinationCount >= 3) { document.getElementById('add-dest-btn').disabled = true; }
        }

        function removeDestination(id) {
            const element = document.getElementById('dest-' + id);
            if (element) {
                element.remove();
                delete geocodedCoords.destinations[id];
                destinationCount--;
                const addBtn = document.getElementById('add-dest-btn');
                if (addBtn) addBtn.disabled = false;
            }
        }

        async function calculateSingleRoute() {
            const startInput = document.getElementById('start-address').value.trim();
            const endInput = document.getElementById('end-address').value.trim();
            if (!startInput || !endInput) { showError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ xu·∫•t ph√°t v√† ƒë√≠ch'); return; }
            if (!geocodedCoords.start) await geocodeAddress('start');
            if (!geocodedCoords.end) await geocodeAddress('end');
            if (!geocodedCoords.start || !geocodedCoords.end) { showError('Kh√¥ng th·ªÉ t√¨m th·∫•y t·ªça ƒë·ªô.'); return; }

            const {lat: startLat, lon: startLon} = geocodedCoords.start;
            const {lat: endLat, lon: endLon} = geocodedCoords.end;
            showLoading(true); clearMap();

            try {
                const response = await fetch('/MapRouting/api/route', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ start_lat: startLat, start_lon: startLon, end_lat: endLat, end_lon: endLon, vehicle: selectedVehicle })
                });
                const data = await response.json();
                if (data.success) { displayRoute(data.route, false); displayResultInfo(data.route); }
                else { showError(data.error); }
            } catch (error) { showError('L·ªói k·∫øt n·ªëi: ' + error.message); }
            finally { showLoading(false); }
        }

        async function calculateMultiRoute() {
            if (!document.getElementById('multi-start-address').value.trim()) { showError('Vui l√≤ng nh·∫≠p ƒë·ªãa ch·ªâ xu·∫•t ph√°t'); return; }
            if (!geocodedCoords['multi-start']) await geocodeAddress('multi-start');
            if (!geocodedCoords['multi-start']) { showError('Kh√¥ng th·ªÉ t√¨m th·∫•y t·ªça ƒë·ªô ƒëi·ªÉm xu·∫•t ph√°t'); return; }

            let allDestinationsValid = true;
             for (let i = 1; i <= destinationCount; i++) {
                const elem = document.getElementById('dest-' + i);
                if (elem) {
                    const input = document.getElementById(`dest-${i}-address`);
                    if (input && input.value.trim()) {
                        if (!geocodedCoords.destinations[i]) await geocodeDestination(i);
                        if (!geocodedCoords.destinations[i]) { allDestinationsValid = false; break; }
                    }
                }
            }
            if (!allDestinationsValid) return;

            let destinations = [];
            for (let id in geocodedCoords.destinations) destinations.push(geocodedCoords.destinations[id]);
            if (destinations.length === 0) { showError('Vui l√≤ng th√™m √≠t nh·∫•t 1 ƒëi·ªÉm ƒë·∫øn'); return; }

            const {lat: startLat, lon: startLon} = geocodedCoords['multi-start'];
            showLoading(true); clearMap();

            try {
                const response = await fetch('/MapRouting/api/multi-route', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ start_lat: startLat, start_lon: startLon, destinations: destinations, vehicle: selectedVehicle })
                });
                const data = await response.json();
                if (data.success) { displayRoute(data.route, true); displayResultInfo(data.route, true); }
                else { showError(data.error); }
            } catch (error) { showError('L·ªói k·∫øt n·ªëi: ' + error.message); }
            finally { showLoading(false); }
        }

        function displayRoute(route, isMulti) {
            if (routeLayer) map.removeLayer(routeLayer);
            markersLayer.clearLayers();
            const latlngs = route.coordinates.map(coord => [coord[1], coord[0]]);

            if (isMulti && route.ordered_destinations) {
                L.polyline(latlngs, { color: '#2c3e50', weight: 6, opacity: 0.8, dashArray: '10, 10' }).addTo(markersLayer);
                L.marker(latlngs[0], {icon: createCustomIcon('start')}).addTo(markersLayer);
                route.ordered_destinations.forEach((dest, i) => {
                    L.marker([dest.lat, dest.lon], {icon: createCustomIcon('waypoint', routeColors[i % routeColors.length], i + 1)}).addTo(markersLayer);
                });
                L.marker(latlngs[latlngs.length - 1], {icon: createCustomIcon('end')}).addTo(markersLayer);
            } else {
                routeLayer = L.polyline(latlngs, { color: '#2c3e50', weight: 6, opacity: 0.8, dashArray: '10, 10' }).addTo(map);
                L.marker(latlngs[0], {icon: createCustomIcon('start')}).addTo(markersLayer);
                L.marker(latlngs[latlngs.length - 1], {icon: createCustomIcon('end')}).addTo(markersLayer);
            }
            map.fitBounds(L.latLngBounds(latlngs), {padding: [50, 50]});
        }

        function displayResultInfo(route, isMulti = false) {
            const distance = (route.distance / 1000).toFixed(2);
            const time = Math.round(route.time / 60000);
            let html = `
                <div class="info-card"><div class="label">DISTANCE</div><div class="value">${distance} KM</div></div>
                <div class="info-card"><div class="label">TIME EST.</div><div class="value">${time} MIN</div></div>
            `;
            if (isMulti) {
                html += `
                    <div class="info-card"><div class="label">WAYPOINTS</div><div class="value">${route.order.length}</div></div>
                    <div class="info-card"><div class="label">ORDER</div><div class="value">${route.order.join(' ‚Üí ')}</div></div>
                `;
            }
            if (route.vietnam_check && route.vietnam_check.warning) {
                html += `<div class="info-card" style="grid-column: 1 / -1; background: #fff3cd; border: 3px solid #ffc107;">
                        <div class="label" style="color: #856404;">WARNING</div><div style="color: #856404; font-family: monospace; margin-top: 8px;">${route.vietnam_check.warning}</div></div>`;
            }
            document.getElementById('result-info').innerHTML = html;
            document.getElementById('result-panel').classList.add('show');
        }

        function clearMap() {
            if (routeLayer) { map.removeLayer(routeLayer); routeLayer = null; }
            markersLayer.clearLayers();
            document.getElementById('result-panel').classList.remove('show');
        }

        function showLoading(show) { document.getElementById('loading').classList.toggle('show', show); }
        function showError(message, isError = true) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = (isError ? '> ERROR: ' : '> SUCCESS: ') + message;
            errorDiv.style.background = isError ? '#d95763' : '#4CAF50';
            errorDiv.classList.add('show');
            setTimeout(() => errorDiv.classList.remove('show'), 5000);
        }

        window.onload = function() {
            console.log('SYSTEM BOOTING...');
            initMap();
            addDestination();
            loadFavorites(); // Load Favorites khi kh·ªüi ƒë·ªông
        };
    </script>
</body>
</html>